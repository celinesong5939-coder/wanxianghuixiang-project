<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸‡è±¡å›å“ | æ„¿æ™¯æ¿</title>
    
    <link href="https://fonts.font.im/css2?family=Noto+Serif+SC:wght@300;700;900&family=Cinzel:wght@400;700&family=Caveat:wght@700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <style>
        /* --- 0. åŸºç¡€å˜é‡ --- */
        :root {
            --bg-deep: #050a14; 
            --gold: #d97706;
            --blue: #38bdf8;
            --font-main: "Noto Serif SC", serif;
            --font-tech: "Cinzel", serif;
            --font-hand: "Caveat", cursive;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body {
            margin: 0; padding: 0;
            background-color: var(--bg-deep);
            color: #94a3b8; font-family: var(--font-main);
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column; align-items: center;
        }

        /* --- 1. èƒŒæ™¯æµæ˜Ÿé›¨ Canvas --- */
        #meteor-canvas { position: fixed; inset: 0; z-index: 0; pointer-events: none; opacity: 1; transition: opacity 1s; }
        body.mode-dark #meteor-canvas { opacity: 0.15; } /* ç”Ÿæˆæ—¶å˜æš— */

        /* --- 2. HUD & Logo --- */
        .hud-layer { position: fixed; inset: 0; pointer-events: none; z-index: 10; transition: opacity 0.5s; }
        .logo-box { position: absolute; top: 24px; left: 24px; }
        .logo-main { font-size: 14px; font-weight: 900; letter-spacing: 2px; color: #fff; }
        .logo-sub { font-size: 8px; letter-spacing: 1px; color: rgba(255,255,255,0.4); }
        .studio-mark { position: absolute; top: 28px; right: 24px; font-family: var(--font-tech); font-size: 10px; color: rgba(255,255,255,0.5); }

        /* --- 3. é˜¶æ®µå®¹å™¨ --- */
        .stage { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.6s ease; opacity: 0; pointer-events: none; transform: scale(0.95); z-index: 1; }
        .stage.active { opacity: 1; pointer-events: auto; transform: scale(1); z-index: 20; }

        /* --- 4. æ ¸å¿ƒç²’å­çƒ (å›å½’ç‰ˆï¼šè½¨é“+é™æ­¢æ ¸å¿ƒ) --- */
        .sphere-wrapper {
            width: 220px; height: 220px; position: relative; cursor: pointer;
            transition: all 0.5s ease;
        }
        /* æ—‹è½¬çš„è½¨é“ */
        .rings-container {
            position: absolute; inset: 0;
            transform-style: preserve-3d;
            perspective: 1000px;
            animation: slow-spin 20s linear infinite;
        }
        .orbit {
            position: absolute; inset: 0; border-radius: 50%;
            border: 1px dotted rgba(148, 163, 184, 0.4);
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.1);
        }
        .orbit:nth-child(1) { transform: rotateY(0deg); opacity: 0.6; border-style: solid; border-width: 0.5px; }
        .orbit:nth-child(2) { transform: rotateY(60deg); }
        .orbit:nth-child(3) { transform: rotateY(120deg); }

        /* é™æ­¢çš„æ ¸å¿ƒ */
        .static-core {
            position: absolute; top: 50%; left: 50%;
            width: 34px; height: 34px;
            transform: translate(-50%, -50%);
            z-index: 5;
        }
        .core-body {
            width: 100%; height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle at 35% 35%, #fff, #94a3b8 60%, #0f172a 100%);
            box-shadow: 0 0 40px rgba(56, 189, 248, 0.5), inset 0 0 10px rgba(255,255,255,0.8);
            animation: breathe-core 4s ease-in-out infinite;
        }

        /* åŠ¨ç”»å®šä¹‰ */
        @keyframes slow-spin { 0% { transform: rotateY(0deg) rotateX(20deg); } 100% { transform: rotateY(360deg) rotateX(380deg); } }
        @keyframes breathe-core { 0%, 100% { transform: scale(1); box-shadow: 0 0 30px rgba(56, 189, 248, 0.4); } 50% { transform: scale(1.1); box-shadow: 0 0 50px rgba(56, 189, 248, 0.7); } }

        /* --- 5. é˜¶æ®µäºŒï¼šæ¿å—é€‰æ‹© --- */
        .cat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 80%; max-width: 400px; }
        .cat-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 25px 15px; text-align: center; border-radius: 12px; cursor: pointer; backdrop-filter: blur(10px); transition: all 0.2s; }
        .cat-card:active { background: var(--gold); color: #000; border-color: var(--gold); transform: scale(0.95); }
        .cat-icon { font-size: 24px; color: var(--gold); margin-bottom: 8px; }
        .cat-title { font-size: 14px; letter-spacing: 2px; color: #fff; }

        /* --- 6. é˜¶æ®µä¸‰ï¼šæ»‘åŠ¨ --- */
        .card-container { width: 100%; height: 60vh; position: relative; display: flex; justify-content: center; align-items: center; perspective: 1000px; }
        .swipe-card { 
            position: absolute; width: 80%; max-width: 320px; aspect-ratio: 9/16; 
            background: #1e293b; border-radius: 8px; overflow: hidden; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.8); 
            border: 4px solid #fff; border-bottom-width: 20px; 
            transform-origin: 50% 120%; transition: transform 0.1s linear; 
        }
        .swipe-card img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .stamp { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%) rotate(-15deg) scale(0); 
            border: 4px solid var(--gold); color: var(--gold); font-size: 32px; font-weight: 900; 
            padding: 10px 20px; opacity: 0; z-index: 10; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
        }
        
        .progress-bar { position: absolute; bottom: 40px; width: 120px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; }
        .progress-fill { height: 100%; background: var(--gold); width: 0%; transition: width 0.3s; }

        /* --- 7. é˜¶æ®µå››ï¼šç»“æœ --- */
        .result-preview-box { width: 65%; max-width: 300px; margin-top: 10px; box-shadow: 0 0 50px rgba(0,0,0,0.8); border: 1px solid #333; }
        .result-img { width: 100%; display: block; }
        .switch-btns { display: flex; gap: 10px; margin-top: 20px; }
        .sw-btn { padding: 8px 16px; border: 1px solid rgba(255,255,255,0.2); color: #fff; font-size: 12px; border-radius: 20px; cursor: pointer; }
        .sw-btn.active { background: var(--gold); border-color: var(--gold); color: #000; font-weight: bold; }

        /* --- 8. éšè—ç”»å¸ƒ (æ‹¼å›¾é€»è¾‘) --- */
        .hidden-canvas { position: fixed; top: -9999px; left: 0; background: #000; overflow: hidden; }
        #canvas-phone { width: 1080px; height: 1920px; }
        #canvas-pad { width: 1600px; height: 1200px; }

        /* åº•å±‚èƒŒæ™¯æ¨¡ç³Šå›¾ */
        .bg-layer-img { position: absolute; object-fit: cover; opacity: 0.4; filter: blur(25px) contrast(1.2) brightness(0.8); transform: scale(1.2); }
        /* é¡¶å±‚æ‹ç«‹å¾— */
        .collage-item { position: absolute; padding: 10px 10px 30px 10px; background: #fff; box-shadow: 0 15px 40px rgba(0,0,0,0.6); transition: none; transform-origin: center center; }
        .collage-img { width: 100%; height: 100%; object-fit: cover; display: block; }
        
        /* è£…é¥°æ–‡å­— */
        .sticker-year { position: absolute; font-family: var(--font-tech); font-weight: 900; color: #fff; text-shadow: 0 5px 20px rgba(0,0,0,0.5); z-index: 100; mix-blend-mode: overlay; pointer-events: none; }
        .sticker-text { position: absolute; background: #000; color: #fff; padding: 5px 15px; font-family: var(--font-main); font-weight: bold; z-index: 100; letter-spacing: 4px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <!-- èƒŒæ™¯ï¼šæµæ˜Ÿé›¨ -->
    <canvas id="meteor-canvas"></canvas>
    
    <!-- HUD -->
    <div class="hud-layer">
        <div class="logo-box"><div class="logo-main">ä¸‡è±¡å›å“</div><div class="logo-sub">æ°´æ¯éª¨å¤´å·¥ä½œå®¤</div></div>
        <div class="studio-mark">ZIGZAG STUDIO</div>
    </div>

    <!-- 1. å¼€åœº (å›å½’ï¼šè½¨é“+æ ¸å¿ƒ) -->
    <div id="stage-intro" class="stage active">
        <div class="sphere-wrapper" onclick="goToCategories()">
            <div class="rings-container">
                <div class="orbit"></div><div class="orbit"></div><div class="orbit"></div>
            </div>
            <div class="static-core">
                <div class="core-body"></div>
            </div>
        </div>
        <div style="margin-top:40px; letter-spacing:6px; font-size:12px; color:#fff; text-shadow:0 0 10px rgba(56,189,248,0.5);">è§¦ç¢°æ˜Ÿå°˜ Â· å¼€å¯æ˜¾åŒ–</div>
    </div>

    <!-- 2. åˆ†ç±» (å·²ä¿®æ”¹ä¸ºï¼šè´¢å¯Œ/ç¾è²Œ/ä¼´ä¾£/ç”Ÿæ´») -->
    <div id="stage-category" class="stage">
        <div class="cat-grid">
            <div class="cat-card" onclick="startSwiping('WEALTH')">
                <div class="cat-icon">âœ¦</div><div class="cat-title">è´¢å¯Œä¸°ç››</div>
            </div>
            <div class="cat-card" onclick="startSwiping('BEAUTY')">
                <div class="cat-icon">âœ¨</div><div class="cat-title">ç»ä¸–ç¾è²Œ</div>
            </div>
            <div class="cat-card" onclick="startSwiping('PARTNER')">
                <div class="cat-icon">â™¥</div><div class="cat-title">çµé­‚ä¼´ä¾£</div>
            </div>
            <div class="cat-card" onclick="startSwiping('LIFE')">
                <div class="cat-icon">ğŸŒ¿</div><div class="cat-title">ç†æƒ³ç”Ÿæ´»</div>
            </div>
        </div>
    </div>

    <!-- 3. ç­›é€‰ -->
    <div id="stage-swipe" class="stage">
        <div class="card-container" id="card-stack"></div>
        <div class="progress-bar"><div class="progress-fill" id="prog-fill"></div></div>
        <div style="position:absolute; bottom:55px; font-size:10px; letter-spacing:2px;">æ”¶é›†èƒ½é‡: <span id="count-val">0</span>/12</div>
        <div style="position:absolute; bottom:80px; width:100%; display:flex; justify-content:center; gap:80px;">
            <div onclick="manualSwipe('left')" style="font-size:30px; cursor:pointer; opacity:0.5;">âœ•</div>
            <div onclick="manualSwipe('right')" style="font-size:30px; color:var(--gold); cursor:pointer;">â—‹</div>
        </div>
    </div>

    <!-- 4. åŠ è½½ -->
    <div id="stage-loading" class="stage">
        <div style="width:40px; height:40px; border:2px solid #333; border-top-color:var(--gold); border-radius:50%; animation:slow-spin 1s linear infinite;"></div>
        <div style="margin-top:20px; letter-spacing:4px; font-size:10px;">æ­£åœ¨ç¼–ç»‡æ„¿æ™¯æ¿...</div>
        <div id="loading-text" style="margin-top:5px; font-size:9px; color:#555;">åŠ è½½é«˜æ¸…ç´ æ 0%</div>
    </div>

    <!-- 5. ç»“æœ -->
    <div id="stage-result" class="stage">
        <div class="result-preview-box"><img id="final-img" class="result-img" src=""></div>
        <div class="switch-btns">
            <div class="sw-btn active" id="btn-phone" onclick="showResult('phone')">æ‰‹æœº (9:16)</div>
            <div class="sw-btn" id="btn-pad" onclick="showResult('pad')">iPad (4:3)</div>
        </div>
        <div style="margin-top:20px; font-size:10px; color:#666;">é•¿æŒ‰ä¿å­˜ Â· è®¾å®šä¸ºé”å±</div>
        <div onclick="location.reload()" style="margin-top:20px; color:var(--gold); font-size:12px; cursor:pointer;">é‡æ–°åˆ¶ä½œ</div>
    </div>

    <!-- ç”»å¸ƒ Phone -->
    <div id="canvas-phone" class="hidden-canvas">
        <div id="bg-phone" style="position:absolute; inset:0; overflow:hidden;"></div>
        <div id="layer-phone" style="position:absolute; inset:0;"></div>
        <div class="sticker-year" style="top:80px; left:40px; font-size:180px; opacity:0.8;">2026</div>
        <div class="sticker-text" style="bottom:120px; right:40px; font-size:24px;">MANIFEST</div>
    </div>

    <!-- ç”»å¸ƒ Pad -->
    <div id="canvas-pad" class="hidden-canvas">
        <div id="bg-pad" style="position:absolute; inset:0; overflow:hidden;"></div>
        <div id="layer-pad" style="position:absolute; inset:0;"></div>
        <div class="sticker-year" style="top:60px; right:60px; font-size:200px; opacity:0.8;">2026</div>
        <div class="sticker-text" style="bottom:80px; left:60px; font-size:32px;">DREAM LIFE</div>
    </div>

    <script>
       // ==========================================
        //  ğŸ‘‡ æ™ºèƒ½å›¾ç‰‡åŠ è½½é…ç½®
        // ==========================================
        
        // 1. ä½ çš„ Supabase é¡¹ç›®å‰ç¼€ (ç¡®ä¿æœ€åæœ‰æ–œæ  /)
        const BASE_URL = "https://cmkqytnhqfwhkjikozla.supabase.co/storage/v1/object/public/assets/";

        // 2. è®¾å®šæœ€å¤§æ¢æµ‹æ•°é‡ (æ¯”å¦‚ä½ è§‰å¾—æœªæ¥æœ€å¤šä¼šä¼ åˆ° 60 å¼ ï¼Œå°±å¡« 60)
        // ä»£ç ä¼šè‡ªåŠ¨æ£€æµ‹ 1.jpg åˆ° 60.jpgï¼Œå­˜åœ¨çš„æ˜¾ç¤ºï¼Œä¸å­˜åœ¨çš„è‡ªåŠ¨å¿½ç•¥
        const MAX_PROBE_COUNT = 100; 

        // ==========================================
        //  ğŸ‘‡ æ ¸å¿ƒé€»è¾‘ (ä¸ç”¨åŠ¨)
        // ==========================================

        // é¢„ç”Ÿæˆæ‰€æœ‰å¯èƒ½çš„é“¾æ¥ (1 åˆ° MAX)
        function generatePotentialLinks(folder) {
            let arr = [];
            for (let i = 1; i <= MAX_PROBE_COUNT; i++) {
                arr.push(`${BASE_URL}${folder}/${i}.jpg`);
            }
            return arr;
        }

        // åŸå§‹æ•°æ®åº“ç»“æ„ (åŒ…å«æ‰€æœ‰å¯èƒ½çš„é“¾æ¥)
        const rawDb = {
            WEALTH: generatePotentialLinks('WEALTH'),
            BEAUTY: generatePotentialLinks('BEAUTY'),
            PARTNER: generatePotentialLinks('PARTNER'),
            LIFE: generatePotentialLinks('LIFE')
        };

        // å…¨å±€å˜é‡
        let currentCards = [];
        let selectedCards = [];
        let maxSelection = 12;
        let generatedImages = { phone: null, pad: null };

        /* --- æ™ºèƒ½éªŒè¯å‡½æ•° --- */
        // è¿™ä¸ªå‡½æ•°ä¼šåœ¨ä½ ç‚¹å‡»æ¿å—æ—¶è¿è¡Œï¼Œå¿«é€Ÿæ£€æµ‹å“ªäº›å›¾ç‰‡æ˜¯çœŸå®å­˜åœ¨çš„
        async function validateAndLoadImages(category) {
            // æ˜¾ç¤ºåŠ è½½æç¤º
            const grid = document.querySelector('.cat-grid');
            const originalContent = grid.innerHTML;
            grid.innerHTML = `<div style="grid-column:span 2; text-align:center; color:#fff; padding:40px;">
                                <div style="font-size:24px; margin-bottom:10px;">ğŸ“¡</div>
                                <div>æ­£åœ¨è¿æ¥å®‡å®™æ•°æ®åº“...</div>
                                <div style="font-size:10px; opacity:0.6; margin-top:5px;">æ£€æµ‹èƒ½é‡ç¢ç‰‡ä¸­</div>
                              </div>`;

            const potentialLinks = rawDb[category];
            const validLinks = [];

            // å¹¶å‘æ£€æµ‹æ‰€æœ‰å›¾ç‰‡
            await Promise.all(potentialLinks.map(url => {
                return new Promise(resolve => {
                    const img = new Image();
                    img.src = url;
                    // å¦‚æœå›¾ç‰‡åŠ è½½æˆåŠŸï¼ŒåŠ å…¥æœ‰æ•ˆåˆ—è¡¨
                    img.onload = () => { 
                        validLinks.push(url); 
                        resolve(); 
                    };
                    // å¦‚æœå›¾ç‰‡ä¸å­˜åœ¨(404)ï¼Œç›´æ¥å¿½ç•¥
                    img.onerror = () => { 
                        resolve(); 
                    };
                });
            }));

            // æ¢å¤ç•Œé¢
            grid.innerHTML = originalContent;

            // å¦‚æœæœ‰æ•ˆå›¾ç‰‡å¤ªå°‘(æ¯”å¦‚è¿˜æ²¡ä¸Šä¼ )ï¼Œå°±è‡ªåŠ¨å¤åˆ¶å¡«å……ï¼Œé˜²æ­¢ bug
            if (validLinks.length < 5) {
                console.warn(`${category} æ¿å—å›¾ç‰‡å¤ªå°‘ï¼Œå¯åŠ¨è‡ªåŠ¨å…‹éš†æ¨¡å¼`);
                while (validLinks.length > 0 && validLinks.length < 20) {
                    validLinks.push(...validLinks);
                }
            }

            return validLinks;
        }

        /* --- ä¿®æ”¹åçš„å¼€å§‹å‡½æ•° --- */
        async function startSwiping(cat) {
            // 1. å…ˆå»æ¢æµ‹å“ªäº›å›¾ç‰‡æ˜¯æ´»çš„
            const validImages = await validateAndLoadImages(cat);
            
            if (validImages.length === 0) {
                alert("è¯¥æ¿å—æš‚æ—¶æ²¡æœ‰æ¢æµ‹åˆ°èƒ½é‡å›¾ç‰‡ï¼Œè¯·æ£€æŸ¥ Supabase æ–‡ä»¶å¤¹å‘½å (1.jpg, 2.jpg...)");
                return;
            }

            // 2. æ´—ç‰Œ
            currentCards = [...validImages].sort(() => Math.random() - 0.5);
            selectedCards = [];
            
            // 3. åˆå§‹åŒ–å †å 
            initStack();
            switchStage('swipe');
        }

        /* --- å¡ç‰‡æ»‘åŠ¨é€»è¾‘ (ä¿æŒä¸å˜) --- */
        let cardStackEl = document.getElementById('card-stack');
        let currentDragCard = null, startX = 0;

        function initStack() {
            cardStackEl.innerHTML = '';
            currentCards.forEach((url, i) => {
                if(i>3) return;
                let el = document.createElement('div');
                el.className = 'swipe-card';
                el.style.zIndex = 100-i;
                if(i>0) { el.style.transform = `scale(${1-i*0.05}) translateY(${i*15}px)`; el.style.opacity = 0.5; }
                el.innerHTML = `<img src="${url}"><div class="stamp">YES</div>`;
                cardStackEl.appendChild(el);
            });
            bindEvents();
            let pct = (selectedCards.length/maxSelection)*100;
            document.getElementById('prog-fill').style.width = pct+'%';
            document.getElementById('count-val').innerText = selectedCards.length;
        }

        function bindEvents() {
            let cards = document.querySelectorAll('.swipe-card');
            if(cards.length===0) return;
            cards.forEach((c,i)=>{ c.style.display = i<3 ? 'block':'none'; });
            currentDragCard = cards[0];
            if(!currentDragCard) return;

            currentDragCard.addEventListener('touchstart', e=>{ startX=e.touches[0].clientX; currentDragCard.style.transition='none'; });
            currentDragCard.addEventListener('touchmove', e=>{ handleMove(e.touches[0].clientX - startX); });
            currentDragCard.addEventListener('touchend', e=>{ handleEnd(e.changedTouches[0].clientX - startX); });
            
            currentDragCard.onmousedown = e=>{
                startX=e.clientX; currentDragCard.style.transition='none';
                document.onmousemove = ev=>handleMove(ev.clientX - startX);
                document.onmouseup = ev=>{ handleEnd(ev.clientX - startX); document.onmousemove=null; };
            };
        }

        function handleMove(delta) {
            currentDragCard.style.transform = `translateX(${delta}px) rotate(${delta*0.1}deg)`;
            let stamp = currentDragCard.querySelector('.stamp');
            if(delta>50) { stamp.style.opacity = Math.min((delta-50)/100, 1); } 
            else { stamp.style.opacity = 0; }
        }

        function handleEnd(delta) {
            currentDragCard.style.transition = 'transform 0.3s ease';
            if(delta > 100) { selectedCards.push(currentCards[0]); flyAway(1); }
            else if(delta < -100) { flyAway(-1); }
            else { currentDragCard.style.transform = 'translateX(0)'; currentDragCard.querySelector('.stamp').style.opacity = 0; }
        }

        function flyAway(dir) {
            currentDragCard.style.transform = `translateX(${dir*500}px) rotate(${dir*30}deg)`;
            setTimeout(()=>{
                currentCards.shift();
                if(selectedCards.length >= maxSelection) prepareGeneration();
                else initStack();
            }, 200);
        }
        function manualSwipe(dir) { if(currentDragCard) handleEnd(dir==='right'?150:-150); }

        /* --- æ ¸å¿ƒï¼šé›¶ç¼éš™ç”Ÿæˆç®—æ³• (ä¿æŒä¸å˜) --- */
        async function prepareGeneration() {
            switchStage('loading');
            document.body.classList.add('mode-dark'); // å˜æš—èƒŒæ™¯æµæ˜Ÿ

            let loadedCount = 0;
            const total = selectedCards.length;
            const updateLoadText = () => document.getElementById('loading-text').innerText = `åŠ è½½é«˜æ¸…ç´ æ ${Math.round((loadedCount/total)*100)}%`;
            
            await Promise.all(selectedCards.map(src => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.crossOrigin = "anonymous";
                    img.src = src;
                    img.onload = () => { loadedCount++; updateLoadText(); resolve(img); };
                    img.onerror = () => { loadedCount++; resolve(null); };
                });
            }));

            layoutCanvas('phone', 1080, 1920, 3, 4);
            layoutCanvas('pad', 1600, 1200, 4, 3);

            setTimeout(async () => {
                generatedImages.phone = await render('canvas-phone');
                generatedImages.pad = await render('canvas-pad');
                showResult('phone');
                switchStage('result');
            }, 1000);
        }

        function layoutCanvas(type, W, H, cols, rows) {
            const bgContainer = document.getElementById('bg-'+type);
            const layerContainer = document.getElementById('layer-'+type);
            bgContainer.innerHTML = ''; layerContainer.innerHTML = '';

            // 1. åº•å±‚èƒŒæ™¯é“ºæ»¡ (æ¶ˆç­é»‘ç¼éš™)
            for(let i=0; i<6; i++) {
                let img = document.createElement('img');
                img.src = selectedCards[i % selectedCards.length];
                img.className = 'bg-layer-img';
                img.style.left = (Math.random()*W - W/2) + 'px';
                img.style.top = (Math.random()*H - H/2) + 'px';
                img.style.width = W + 'px'; img.style.height = H + 'px';
                bgContainer.appendChild(img);
            }

            // 2. é¡¶å±‚å †å 
            const cellW = W / cols;
            const cellH = H / rows;

            selectedCards.forEach((url, i) => {
                let col = i % cols;
                let row = Math.floor(i / cols);
                if(i >= cols*rows) { col = Math.floor(Math.random()*cols); row = Math.floor(Math.random()*rows); }

                let scale = 1.3 + Math.random() * 0.5; 
                let w = cellW * scale;
                let h = w * 1.4;

                let offsetX = (Math.random()-0.5) * cellW * 0.8;
                let offsetY = (Math.random()-0.5) * cellH * 0.8;
                
                let x = col * cellW + cellW/2 - w/2 + offsetX;
                let y = row * cellH + cellH/2 - h/2 + offsetY;
                let rot = (Math.random()-0.5) * 40; 

                let div = document.createElement('div');
                div.className = 'collage-item';
                div.style.width = w + 'px';
                div.style.height = h + 'px';
                div.style.left = x + 'px';
                div.style.top = y + 'px';
                div.style.transform = `rotate(${rot}deg)`;
                div.style.zIndex = Math.floor(Math.random()*20);

                let img = document.createElement('img');
                img.src = url;
                img.className = 'collage-img';
                img.crossOrigin = "anonymous";

                div.appendChild(img);
                layerContainer.appendChild(div);
            });
        }

        async function render(id) {
            let c = await html2canvas(document.getElementById(id), { scale: 2, useCORS: true, backgroundColor:null });
            return c.toDataURL('image/jpeg', 0.9);
        }

        function showResult(t) {
            document.getElementById('final-img').src = generatedImages[t];
            document.querySelectorAll('.sw-btn').forEach(b=>b.classList.remove('active'));
            document.getElementById('btn-'+t).classList.add('active');
        }

        /* --- æµæ˜Ÿé›¨ç³»ç»Ÿ (Meteor System) --- */
        const canvas = document.getElementById('meteor-canvas');
        const ctx = canvas.getContext('2d');
        let w, height, meteors = [];

        window.addEventListener('resize', () => {
            w = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        });
        // Init size
        w = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;

        class Meteor {
            constructor() { this.reset(true); }
            reset(initial = false) {
                this.x = Math.random() * w + (initial ? 0 : w/2);
                this.y = Math.random() * height/2 - height/2; 
                this.length = Math.random() * 80 + 20;
                this.speed = Math.random() * 8 + 4;
                this.size = Math.random() * 2 + 0.5;
                this.angle = Math.PI / 4 + (Math.random() - 0.5) * 0.2; // 45åº¦è§’
                this.opacity = Math.random() * 0.5 + 0.1;
            }
            update() {
                this.x -= this.speed * Math.cos(this.angle);
                this.y += this.speed * Math.sin(this.angle);
                if (this.x < -100 || this.y > height + 100) this.reset();
            }
            draw() {
                const tailX = this.x + this.length * Math.cos(this.angle);
                const tailY = this.y - this.length * Math.sin(this.angle);
                const gradient = ctx.createLinearGradient(this.x, this.y, tailX, tailY);
                gradient.addColorStop(0, `rgba(255, 255, 255, ${this.opacity})`);
                gradient.addColorStop(1, `rgba(255, 255, 255, 0)`);
                ctx.beginPath(); ctx.moveTo(this.x, this.y); ctx.lineTo(tailX, tailY);
                ctx.strokeStyle = gradient; ctx.lineWidth = this.size; ctx.lineCap = 'round'; ctx.stroke();
            }
        }

        for(let i=0; i<30; i++) meteors.push(new Meteor());

        function animate() {
            ctx.clearRect(0, 0, w, height);
            meteors.forEach(m => { m.update(); m.draw(); });
            requestAnimationFrame(animate);
        }
        animate();
    </script>
</body>

</html>


