<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>万象回响 | 愿景板</title>
    
    <link href="https://fonts.font.im/css2?family=Noto+Serif+SC:wght@300;700;900&family=Cinzel:wght@400;700&family=Caveat:wght@700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <script>
        (function() {
            const originalGetContext = HTMLCanvasElement.prototype.getContext;
            HTMLCanvasElement.prototype.getContext = function(type, attributes) {
                if (type === '2d') { attributes = attributes || {}; attributes.willReadFrequently = true; }
                return originalGetContext.call(this, type, attributes);
            };
        })();
    </script>

    <style>
        /* --- 0. 基础 --- */
        :root { --bg-deep: #050a14; --gold: #d97706; --font-main: "Noto Serif SC", serif; --font-tech: "Cinzel", serif; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; background-color: var(--bg-deep); color: #94a3b8; font-family: var(--font-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; align-items: center; }

        #meteor-canvas { position: fixed; inset: 0; z-index: 0; pointer-events: none; opacity: 1; transition: opacity 1s; }
        body.mode-dark #meteor-canvas { opacity: 0.15; }

        .hud-layer { position: fixed; inset: 0; pointer-events: none; z-index: 10; }
        .logo-box { position: absolute; top: 24px; left: 24px; }
        .logo-main { font-size: 14px; font-weight: 900; letter-spacing: 2px; color: #fff; }
        .studio-mark { position: absolute; top: 28px; right: 24px; font-family: var(--font-tech); font-size: 10px; color: rgba(255,255,255,0.5); }

        .stage { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.8s cubic-bezier(0.22, 1, 0.36, 1); opacity: 0; pointer-events: none; transform: scale(0.98); z-index: 1; }
        .stage.active { opacity: 1; pointer-events: auto; transform: scale(1); z-index: 20; }

        /* --- 1. 核心 --- */
        .sphere-wrapper { width: 220px; height: 220px; position: relative; cursor: pointer; transition: transform 0.3s; }
        .sphere-wrapper:active { transform: scale(0.95); }
        .rings-container { position: absolute; inset: 0; transform-style: preserve-3d; perspective: 1000px; animation: slow-spin 20s linear infinite; }
        .orbit { position: absolute; inset: 0; border-radius: 50%; border: 1px dotted rgba(148, 163, 184, 0.4); box-shadow: 0 0 15px rgba(56, 189, 248, 0.1); }
        .orbit:nth-child(1) { transform: rotateY(0deg); border-style: solid; border-width: 0.5px; opacity: 0.6; }
        .orbit:nth-child(2) { transform: rotateY(60deg); }
        .orbit:nth-child(3) { transform: rotateY(120deg); }
        .static-core { position: absolute; top: 50%; left: 50%; width: 34px; height: 34px; transform: translate(-50%, -50%); }
        .core-body { width: 100%; height: 100%; border-radius: 50%; background: radial-gradient(circle at 35% 35%, #fff, #94a3b8 60%, #0f172a 100%); box-shadow: 0 0 40px rgba(56, 189, 248, 0.5); animation: breathe 3s infinite; }

        /* --- 2. 呼吸转场文字 --- */
        .journey-status { position: absolute; top: 80px; width: 100%; text-align: center; }
        /* 关键：用 opacity 做转场，不用 display:none */
        .status-content { transition: opacity 0.6s ease, transform 0.6s ease; opacity: 1; transform: translateY(0); }
        .status-content.fade-out { opacity: 0; transform: translateY(-10px); }
        
        .current-realm { font-family: var(--font-tech); font-size: 24px; letter-spacing: 4px; color: var(--gold); text-shadow: 0 0 10px rgba(217,119,6,0.3); }
        .realm-progress { font-size: 10px; letter-spacing: 2px; margin-top: 5px; color: #64748b; }

        /* --- 3. 卡片 --- */
        .card-container { width: 100%; height: 55vh; position: relative; display: flex; justify-content: center; align-items: center; perspective: 1000px; margin-top: 20px; }
        .swipe-card { 
            position: absolute; width: 80%; max-width: 320px; aspect-ratio: 9/16; 
            background: #1e293b; border-radius: 8px; overflow: hidden; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.9); border: 4px solid #fff; border-bottom-width: 30px; 
            transform-origin: 50% 120%; transition: transform 0.1s linear; 
        }
        .swipe-card img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .stamp { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%) rotate(-15deg) scale(0); 
            border: 4px solid var(--gold); color: var(--gold); font-size: 32px; font-weight: 900; 
            padding: 10px 20px; opacity: 0; z-index: 10; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
        }

        .controls { position: absolute; bottom: 60px; width: 100%; display: flex; justify-content: center; gap: 80px; }
        .btn-act { font-size: 32px; cursor: pointer; transition: transform 0.1s; }
        .btn-act:active { transform: scale(0.9); }

        /* --- 4. 结果 --- */
        .result-preview-box { width: 60%; max-width: 280px; margin-top: 20px; box-shadow: 0 0 60px rgba(0,0,0,0.8); border: 1px solid #333; }
        .result-img { width: 100%; display: block; }
        .switch-btns { display: flex; gap: 10px; margin-top: 30px; }
        .sw-btn { padding: 8px 20px; border: 1px solid rgba(255,255,255,0.2); color: #fff; font-size: 12px; border-radius: 20px; cursor: pointer; }
        .sw-btn.active { background: var(--gold); border-color: var(--gold); color: #000; font-weight: bold; }

        /* --- 5. 画布 (高级定点拼贴) --- */
        .hidden-canvas { position: fixed; top: -9999px; left: 0; background: #080c14; overflow: hidden; }
        #canvas-phone { width: 1080px; height: 1920px; }
        #canvas-pad { width: 1600px; height: 1200px; }

        /* 底层背景模糊图 */
        .bg-layer-img { position: absolute; object-fit: cover; opacity: 0.2; filter: blur(50px) contrast(1.2); transform: scale(1.5); }
        
        /* 拍立得样式 */
        .collage-item { 
            position: absolute; 
            padding: 10px 10px 35px 10px; /* 拍立得经典底部留白 */
            background: #fff; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.6); 
            transform-origin: center center; 
        }
        .collage-img { width: 100%; height: 100%; object-fit: cover; display: block; filter: contrast(1.05); }
        
        .sticker-year { position: absolute; font-family: var(--font-tech); font-weight: 900; color: #fff; text-shadow: 0 10px 40px rgba(0,0,0,1); z-index: 200; pointer-events: none; mix-blend-mode: normal; }
        .sticker-text { position: absolute; background: #000; color: #fff; padding: 8px 24px; font-family: var(--font-main); font-weight: bold; z-index: 200; letter-spacing: 6px; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }

        @keyframes slow-spin { 0% { transform: rotateY(0deg) rotateX(20deg); } 100% { transform: rotateY(360deg) rotateX(380deg); } }
        @keyframes breathe { 0%,100% { transform: scale(1); box-shadow: 0 0 30px rgba(56, 189, 248, 0.4); } 50% { transform: scale(1.1); box-shadow: 0 0 50px rgba(56, 189, 248, 0.7); } }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <canvas id="meteor-canvas"></canvas>
    <div class="hud-layer">
        <div class="logo-box"><div class="logo-main">万象回响</div></div>
        <div class="studio-mark">ZIGZAG STUDIO</div>
    </div>

    <!-- 1. 开场 -->
    <div id="stage-intro" class="stage active">
        <div class="sphere-wrapper" onclick="startJourney()">
            <div class="rings-container">
                <div class="orbit"></div><div class="orbit"></div><div class="orbit"></div>
            </div>
            <div class="static-core"><div class="core-body"></div></div>
        </div>
        <div style="margin-top:40px; letter-spacing:6px; font-size:12px; color:#fff; text-shadow:0 0 10px rgba(56,189,248,0.5);">触碰星尘 · 开启旅程</div>
    </div>

    <!-- 2. 旅程 (无缝切换) -->
    <div id="stage-swipe" class="stage">
        <div class="journey-status">
            <!-- 包裹一个div做淡入淡出 -->
            <div id="status-content" class="status-content">
                <div id="realm-title" class="current-realm">WEALTH</div>
                <div id="realm-progress" class="realm-progress">能量收集: 0/3</div>
            </div>
        </div>

        <div class="card-container" id="card-stack"></div>
        
        <div class="controls">
            <div class="btn-act" style="color:#64748b" onclick="manualSwipe('left')">✕</div>
            <div class="btn-act" style="color:var(--gold)" onclick="manualSwipe('right')">○</div>
        </div>
    </div>

    <!-- 3. 加载 -->
    <div id="stage-loading" class="stage">
        <div style="width:50px; height:50px; border:2px solid #333; border-top-color:var(--gold); border-radius:50%; animation:spin 1s linear infinite;"></div>
        <div style="margin-top:30px; letter-spacing:4px; font-size:12px;">正在重构现实...</div>
        <div id="loading-text" style="margin-top:10px; font-size:10px; color:#555;">0%</div>
    </div>

    <!-- 4. 结果 -->
    <div id="stage-result" class="stage">
        <div class="result-preview-box"><img id="final-img" class="result-img" src=""></div>
        <div class="switch-btns">
            <div class="sw-btn active" id="btn-phone" onclick="showResult('phone')">手机壁纸</div>
            <div class="sw-btn" id="btn-pad" onclick="showResult('pad')">iPad壁纸</div>
        </div>
        <div style="margin-top:30px; font-size:10px; color:#666;">长按保存 · 设定为锁屏</div>
        <div onclick="location.reload()" style="margin-top:20px; color:var(--gold); font-size:12px; cursor:pointer; text-decoration: underline;">重新制作</div>
    </div>

    <!-- 画布 Phone -->
    <div id="canvas-phone" class="hidden-canvas">
        <div id="bg-phone" style="position:absolute; inset:0;"></div>
        <div id="layer-phone" style="position:absolute; inset:0;"></div>
        <div class="sticker-year" style="top:80px; left:40px; font-size:180px; opacity:0.9;">2026</div>
        <div class="sticker-text" style="bottom:120px; right:40px; font-size:24px;">MANIFEST</div>
    </div>

    <!-- 画布 Pad -->
    <div id="canvas-pad" class="hidden-canvas">
        <div id="bg-pad" style="position:absolute; inset:0;"></div>
        <div id="layer-pad" style="position:absolute; inset:0;"></div>
        <div class="sticker-year" style="top:60px; right:60px; font-size:200px; opacity:0.9;">2026</div>
        <div class="sticker-text" style="bottom:80px; left:60px; font-size:32px;">DREAM LIFE</div>
    </div>

    <script>
        // ================= 配置区 =================
        const BASE_URL = "https://cmkqytnhqfwhkjikozla.supabase.co/storage/v1/object/public/assets/";
        const MAX_PROBE_COUNT = 100; 

        const JOURNEY = [
            { key: 'WEALTH',  label: 'WEALTH',  target: 3 }, 
            { key: 'BEAUTY',  label: 'BEAUTY',  target: 3 }, 
            { key: 'PARTNER', label: 'PARTNER', target: 3 }, 
            { key: 'LIFE',    label: 'LIFE',    target: 3 }  
        ];

        // ================= 逻辑区 =================

        function generatePotentialLinks(folder) {
            let arr = [];
            for (let i = 1; i <= MAX_PROBE_COUNT; i++) arr.push(`${BASE_URL}${folder}/${i}.jpg`);
            return arr;
        }

        const rawDb = {
            WEALTH: generatePotentialLinks('WEALTH'),
            BEAUTY: generatePotentialLinks('BEAUTY'),
            PARTNER: generatePotentialLinks('PARTNER'),
            LIFE: generatePotentialLinks('LIFE')
        };

        let currentStepIndex = 0;
        let currentSelection = []; 
        let finalSelection = [];   
        let currentCards = [];     
        let generatedImages = { phone: null, pad: null };

        function switchStage(id) {
            document.querySelectorAll('.stage').forEach(el => el.classList.remove('active'));
            document.getElementById('stage-'+id).classList.add('active');
        }

        function goToCategories() {
            startJourney();
        }

        // --- 1. 旅程控制 (呼吸转场修复) ---
        async function startJourney() {
            currentStepIndex = 0;
            finalSelection = [];
            await loadStep(currentStepIndex, true); 
            switchStage('swipe');
        }

        async function loadStep(index, isFirst = false) {
            if (index >= JOURNEY.length) {
                prepareGeneration();
                return;
            }

            const step = JOURNEY[index];
            currentSelection = [];
            
            // 后台加载，不阻塞
            const validImages = await validateAndLoadImages(step.key);
            if (validImages.length === 0) {
                alert(`未找到 ${step.key} 图片，请检查！`);
                return;
            }
            currentCards = [...validImages].sort(() => Math.random() - 0.5);

            // --- 呼吸转场 ---
            const statusBox = document.getElementById('status-content');
            
            if (isFirst) {
                updateUI(step);
                initStack();
            } else {
                // 1. 淡出文字 (呼气)
                statusBox.classList.add('fade-out');
                
                // 2. 等待淡出
                setTimeout(() => {
                    updateUI(step); // 换字
                    initStack();    // 换卡片
                    // 3. 淡入文字 (吸气)
                    statusBox.classList.remove('fade-out');
                }, 600);
            }
        }

        function updateUI(step) {
            document.getElementById('realm-title').innerText = step.label;
            document.getElementById('realm-progress').innerText = `能量收集: 0/${step.target}`;
        }

        async function validateAndLoadImages(key) {
            const potentialLinks = rawDb[key];
            const validLinks = [];
            await Promise.all(potentialLinks.map(url => {
                return new Promise(resolve => {
                    const img = new Image();
                    img.src = url;
                    img.onload = () => { validLinks.push(url); resolve(); };
                    img.onerror = () => { resolve(); };
                });
            }));
            if (validLinks.length > 0 && validLinks.length < 5) {
                while (validLinks.length < 10) validLinks.push(...validLinks);
            }
            return validLinks;
        }

        // --- 2. 卡片交互 ---
        let cardStackEl = document.getElementById('card-stack');
        let currentDragCard = null, startX = 0;

        function initStack() {
            cardStackEl.innerHTML = '';
            currentCards.forEach((url, i) => {
                if(i>3) return;
                let el = document.createElement('div');
                el.className = 'swipe-card';
                el.style.zIndex = 100-i;
                if(i>0) { el.style.transform = `scale(${1-i*0.05}) translateY(${i*15}px)`; el.style.opacity = 0.5; }
                el.innerHTML = `<img src="${url}" crossorigin="anonymous"><div class="stamp">YES</div>`;
                cardStackEl.appendChild(el);
            });
            bindEvents();
        }

        function bindEvents() {
            let cards = document.querySelectorAll('.swipe-card');
            if(cards.length===0) return;
            cards.forEach((c,i)=>{ c.style.display = i<3 ? 'block':'none'; });
            currentDragCard = cards[0];
            if(!currentDragCard && currentCards.length === 0) return;

            currentDragCard.addEventListener('touchstart', e=>{ startX=e.touches[0].clientX; currentDragCard.style.transition='none'; });
            currentDragCard.addEventListener('touchmove', e=>{ handleMove(e.touches[0].clientX - startX); });
            currentDragCard.addEventListener('touchend', e=>{ handleEnd(e.changedTouches[0].clientX - startX); });
            currentDragCard.onmousedown = e=>{
                startX=e.clientX; currentDragCard.style.transition='none';
                document.onmousemove = ev=>handleMove(ev.clientX - startX);
                document.onmouseup = ev=>{ handleEnd(ev.clientX - startX); document.onmousemove=null; };
            };
        }

        function handleMove(delta) {
            currentDragCard.style.transform = `translateX(${delta}px) rotate(${delta*0.1}deg)`;
            let stamp = currentDragCard.querySelector('.stamp');
            if(delta>50) { stamp.style.opacity = Math.min((delta-50)/100, 1); } 
            else { stamp.style.opacity = 0; }
        }

        function handleEnd(delta) {
            currentDragCard.style.transition = 'transform 0.3s ease';
            if(delta > 100) { // Right
                const selectedImg = currentCards[0];
                currentSelection.push(selectedImg);
                finalSelection.push(selectedImg);
                document.getElementById('realm-progress').innerText = `能量收集: ${currentSelection.length}/${JOURNEY[currentStepIndex].target}`;
                flyAway(1);
            } 
            else if(delta < -100) { // Left
                currentCards.push(currentCards[0]); // 循环
                flyAway(-1);
            } 
            else { 
                currentDragCard.style.transform = 'translateX(0)'; 
                currentDragCard.querySelector('.stamp').style.opacity = 0; 
            }
        }

        function flyAway(dir) {
            currentDragCard.style.transform = `translateX(${dir*500}px) rotate(${dir*30}deg)`;
            setTimeout(async ()=>{
                currentCards.shift();
                
                const step = JOURNEY[currentStepIndex];
                if (currentSelection.length >= step.target) {
                    // 转场逻辑：等待0.3秒让卡片飞走，再触发文字淡出
                    setTimeout(async () => {
                        currentStepIndex++;
                        await loadStep(currentStepIndex); 
                    }, 300);
                } else {
                    initStack();
                }
            }, 200);
        }
        function manualSwipe(dir) { if(currentDragCard) handleEnd(dir==='right'?150:-150); }


        /* --- 3. 生成算法 (定点布局 - 彻底解决遮挡) --- */
        async function prepareGeneration() {
            switchStage('loading');
            document.body.classList.add('mode-dark');

            let loadedCount = 0;
            const total = finalSelection.length;
            const updateLoadText = () => document.getElementById('loading-text').innerText = `加载高清素材 ${Math.round((loadedCount/total)*100)}%`;
            
            await Promise.all(finalSelection.map(src => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.crossOrigin = "anonymous";
                    img.src = src;
                    img.onload = () => { loadedCount++; updateLoadText(); resolve(img); };
                    img.onerror = () => { loadedCount++; resolve(null); };
                });
            }));

            // 定点布局：不再随机，使用预设的完美坐标
            layoutFixed('phone', 1080, 1920);
            layoutFixed('pad', 1600, 1200);

            setTimeout(async () => {
                generatedImages.phone = await render('canvas-phone');
                generatedImages.pad = await render('canvas-pad');
                showResult('phone');
                switchStage('result');
            }, 1000);
        }

        // 预设坐标系 (x%, y%, width%, rotation) - 经过调试的完美布局
        const PHONE_LAYOUT = [
            { x: 50, y: 35, w: 55, r: 0, z: 100 }, // C位大图
            { x: 50, y: 70, w: 55, r: -2, z: 99 }, // C位副图
            { x: 20, y: 15, w: 35, r: -5, z: 10 },
            { x: 80, y: 15, w: 35, r: 5, z: 11 },
            { x: 15, y: 50, w: 30, r: 8, z: 12 },
            { x: 85, y: 50, w: 30, r: -8, z: 13 },
            { x: 20, y: 85, w: 35, r: -4, z: 14 },
            { x: 80, y: 85, w: 35, r: 4, z: 15 },
            { x: 50, y: 10, w: 30, r: 0, z: 5 },
            { x: 50, y: 92, w: 30, r: 0, z: 6 },
            { x: 10, y: 30, w: 25, r: -15, z: 1 },
            { x: 90, y: 30, w: 25, r: 15, z: 2 },
        ];

        const PAD_LAYOUT = [
            { x: 35, y: 50, w: 45, r: -2, z: 100 }, // 左C位
            { x: 75, y: 40, w: 40, r: 3, z: 99 },   // 右C位
            { x: 15, y: 20, w: 25, r: -5, z: 10 },
            { x: 50, y: 15, w: 25, r: 0, z: 11 },
            { x: 85, y: 15, w: 25, r: 5, z: 12 },
            { x: 10, y: 80, w: 25, r: 5, z: 13 },
            { x: 50, y: 85, w: 25, r: 0, z: 14 },
            { x: 90, y: 75, w: 25, r: -5, z: 15 },
            { x: 10, y: 50, w: 20, r: -10, z: 5 },
            { x: 90, y: 40, w: 20, r: 10, z: 6 },
            { x: 30, y: 85, w: 22, r: -3, z: 7 },
            { x: 70, y: 10, w: 22, r: 3, z: 8 },
        ];

        function layoutFixed(type, W, H) {
            const bgContainer = document.getElementById('bg-'+type);
            const layerContainer = document.getElementById('layer-'+type);
            bgContainer.innerHTML = ''; layerContainer.innerHTML = '';

            const layout = type === 'phone' ? PHONE_LAYOUT : PAD_LAYOUT;

            // 1. 背景层
            for(let i=0; i<6; i++) {
                let img = document.createElement('img');
                img.src = finalSelection[i % finalSelection.length];
                img.className = 'bg-layer-img';
                img.style.left = (Math.random()*W - W/2) + 'px';
                img.style.top = (Math.random()*H - H/2) + 'px';
                img.style.width = (W*1.5) + 'px'; img.style.height = (H*1.5) + 'px';
                bgContainer.appendChild(img);
            }

            // 2. 核心拼贴层
            // 打乱图片顺序，避免同类图片扎堆
            let shuffledImages = [...finalSelection].sort(() => Math.random() - 0.5);

            layout.forEach((pos, i) => {
                if (i >= shuffledImages.length) return;
                
                let imgUrl = shuffledImages[i];
                let w = (pos.w / 100) * W;
                let h = w * 1.35; // 3:4 比例

                let div = document.createElement('div');
                div.className = 'collage-item';
                div.style.width = w + 'px';
                div.style.height = h + 'px';
                // 坐标转换：百分比转像素，并居中锚点
                div.style.left = ((pos.x / 100) * W - w/2) + 'px';
                div.style.top = ((pos.y / 100) * H - h/2) + 'px';
                div.style.transform = `rotate(${pos.r}deg)`;
                div.style.zIndex = pos.z;

                let img = document.createElement('img');
                img.src = imgUrl;
                img.className = 'collage-img';
                img.crossOrigin = "anonymous";

                div.appendChild(img);
                layerContainer.appendChild(div);
            });
        }

        async function render(id) {
            let c = await html2canvas(document.getElementById(id), { scale: 2, useCORS: true, backgroundColor:null });
            return c.toDataURL('image/jpeg', 0.9);
        }

        function showResult(t) {
            document.getElementById('final-img').src = generatedImages[t];
            document.querySelectorAll('.sw-btn').forEach(b=>b.classList.remove('active'));
            document.getElementById('btn-'+t).classList.add('active');
        }

        /* --- 5. 流星雨 --- */
        const canvas = document.getElementById('meteor-canvas');
        const ctx = canvas.getContext('2d');
        let w, height, meteors = [];
        window.addEventListener('resize', () => { w=canvas.width=window.innerWidth; height=canvas.height=window.innerHeight; });
        w=canvas.width=window.innerWidth; height=canvas.height=window.innerHeight;

        class Meteor {
            constructor() { this.reset(true); }
            reset(initial = false) {
                this.x = Math.random()*w + (initial?0:w/2);
                this.y = Math.random()*height/2 - height/2; 
                this.length = Math.random()*80 + 20;
                this.speed = Math.random()*8 + 4;
                this.size = Math.random()*2 + 0.5;
                this.angle = Math.PI/4 + (Math.random()-0.5)*0.2;
                this.opacity = Math.random()*0.5 + 0.1;
            }
            update() {
                this.x -= this.speed * Math.cos(this.angle);
                this.y += this.speed * Math.sin(this.angle);
                if(this.x < -100 || this.y > height+100) this.reset();
            }
            draw() {
                const tailX = this.x + this.length * Math.cos(this.angle);
                const tailY = this.y - this.length * Math.sin(this.angle);
                const gradient = ctx.createLinearGradient(this.x, this.y, tailX, tailY);
                gradient.addColorStop(0, `rgba(255, 255, 255, ${this.opacity})`);
                gradient.addColorStop(1, `rgba(255, 255, 255, 0)`);
                ctx.beginPath(); ctx.moveTo(this.x, this.y); ctx.lineTo(tailX, tailY);
                ctx.strokeStyle = gradient; ctx.lineWidth = this.size; ctx.lineCap = 'round'; ctx.stroke();
            }
        }
        for(let i=0; i<30; i++) meteors.push(new Meteor());
        function animate() {
            ctx.clearRect(0, 0, w, height);
            meteors.forEach(m => { m.update(); m.draw(); });
            requestAnimationFrame(animate);
        }
        animate();
    </script>
</body>
</html>
