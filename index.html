<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸‡è±¡å›å“ | å…¨ç»´æ„¿æ™¯æ¿</title>
    
    <link href="https://fonts.font.im/css2?family=Noto+Serif+SC:wght@300;700;900&family=Cinzel:wght@400;700&family=Caveat:wght@700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <script>
        // ğŸš€ æ€§èƒ½ä¼˜åŒ–è¡¥ä¸
        (function() {
            const originalGetContext = HTMLCanvasElement.prototype.getContext;
            HTMLCanvasElement.prototype.getContext = function(type, attributes) {
                if (type === '2d') {
                    attributes = attributes || {};
                    attributes.willReadFrequently = true;
                }
                return originalGetContext.call(this, type, attributes);
            };
        })();
    </script>

    <style>
        /* --- 0. åŸºç¡€æ ·å¼ --- */
        :root {
            --bg-deep: #050a14; 
            --gold: #d97706;
            --font-main: "Noto Serif SC", serif;
            --font-tech: "Cinzel", serif;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; background-color: var(--bg-deep); color: #94a3b8; font-family: var(--font-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; align-items: center; }

        /* èƒŒæ™¯æµæ˜Ÿ */
        #meteor-canvas { position: fixed; inset: 0; z-index: 0; pointer-events: none; transition: opacity 1s; }
        body.mode-dark #meteor-canvas { opacity: 0.1; }

        /* HUD */
        .hud-layer { position: fixed; inset: 0; pointer-events: none; z-index: 10; }
        .logo-box { position: absolute; top: 24px; left: 24px; }
        .logo-main { font-size: 14px; font-weight: 900; letter-spacing: 2px; color: #fff; }
        .studio-mark { position: absolute; top: 28px; right: 24px; font-family: var(--font-tech); font-size: 10px; color: rgba(255,255,255,0.5); }

        /* é˜¶æ®µå®¹å™¨ */
        .stage { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.6s ease; opacity: 0; pointer-events: none; transform: scale(0.95); z-index: 1; }
        .stage.active { opacity: 1; pointer-events: auto; transform: scale(1); z-index: 20; }

        /* --- 1. å¼€åœºçƒ --- */
        .sphere-wrapper { width: 220px; height: 220px; position: relative; cursor: pointer; transition: transform 0.3s; }
        .sphere-wrapper:active { transform: scale(0.95); }
        .rings-container { position: absolute; inset: 0; transform-style: preserve-3d; perspective: 1000px; animation: slow-spin 20s linear infinite; }
        .orbit { position: absolute; inset: 0; border-radius: 50%; border: 1px dotted rgba(148, 163, 184, 0.4); box-shadow: 0 0 15px rgba(56, 189, 248, 0.1); }
        .orbit:nth-child(1) { transform: rotateY(0deg); border-style: solid; border-width: 0.5px; opacity: 0.6; }
        .orbit:nth-child(2) { transform: rotateY(60deg); }
        .orbit:nth-child(3) { transform: rotateY(120deg); }
        .static-core { position: absolute; top: 50%; left: 50%; width: 34px; height: 34px; transform: translate(-50%, -50%); }
        .core-body { width: 100%; height: 100%; border-radius: 50%; background: radial-gradient(circle at 35% 35%, #fff, #94a3b8 60%, #0f172a 100%); box-shadow: 0 0 40px rgba(56, 189, 248, 0.5); animation: breathe 3s infinite; }

        /* --- 2. æ—…ç¨‹è¿›åº¦æŒ‡ç¤ºå™¨ (é¡¶éƒ¨) --- */
        .journey-status {
            position: absolute; top: 80px; width: 100%; text-align: center;
            opacity: 0; transition: opacity 0.5s;
        }
        .stage.active .journey-status { opacity: 1; }
        .current-realm { font-family: var(--font-tech); font-size: 24px; letter-spacing: 4px; color: var(--gold); text-shadow: 0 0 10px rgba(217,119,6,0.3); }
        .realm-progress { font-size: 10px; letter-spacing: 2px; margin-top: 5px; color: #64748b; }

        /* --- 3. å¡ç‰‡æ»‘åŠ¨ --- */
        .card-container { width: 100%; height: 55vh; position: relative; display: flex; justify-content: center; align-items: center; perspective: 1000px; margin-top: 20px; }
        .swipe-card { 
            position: absolute; width: 80%; max-width: 320px; aspect-ratio: 9/16; 
            background: #1e293b; border-radius: 8px; overflow: hidden; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.9); 
            border: 4px solid #fff; border-bottom-width: 30px; 
            transform-origin: 50% 120%; transition: transform 0.1s linear; 
        }
        .swipe-card img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .stamp { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%) rotate(-15deg) scale(0); 
            border: 4px solid var(--gold); color: var(--gold); font-size: 32px; font-weight: 900; 
            padding: 10px 20px; opacity: 0; z-index: 10; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
        }

        /* åº•éƒ¨æŒ‰é’® */
        .controls { position: absolute; bottom: 60px; width: 100%; display: flex; justify-content: center; gap: 80px; }
        .btn-act { font-size: 32px; cursor: pointer; transition: transform 0.1s; }
        .btn-act:active { transform: scale(0.9); }

        /* --- 4. ç»“æœé¡µ --- */
        .result-preview-box { width: 60%; max-width: 280px; margin-top: 20px; box-shadow: 0 0 60px rgba(0,0,0,0.8); border: 1px solid #333; }
        .result-img { width: 100%; display: block; }
        .switch-btns { display: flex; gap: 10px; margin-top: 30px; }
        .sw-btn { padding: 8px 20px; border: 1px solid rgba(255,255,255,0.2); color: #fff; font-size: 12px; border-radius: 20px; cursor: pointer; }
        .sw-btn.active { background: var(--gold); border-color: var(--gold); color: #000; font-weight: bold; }

        /* --- 5. éšè—ç”»å¸ƒ (ä¼˜åŒ–ç‰ˆ) --- */
        .hidden-canvas { position: fixed; top: -9999px; left: 0; background: #080c14; overflow: hidden; }
        #canvas-phone { width: 1080px; height: 1920px; }
        #canvas-pad { width: 1600px; height: 1200px; }

        /* æ‹¼è´´å…ƒç´  */
        .collage-item { 
            position: absolute; 
            padding: 12px 12px 45px 12px; /* æ‹ç«‹å¾—åº•éƒ¨ç•™ç™½ */
            background: #fff; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.5); /* é˜´å½± */
            transform-origin: center center;
        }
        .collage-img { width: 100%; height: 100%; object-fit: cover; display: block; filter: contrast(1.05); }
        
        /* è£…é¥°æ–‡å­— */
        .sticker-year { position: absolute; font-family: var(--font-tech); font-weight: 900; color: #fff; text-shadow: 0 10px 30px rgba(0,0,0,0.9); z-index: 100; pointer-events: none; mix-blend-mode: normal; }
        .sticker-text { position: absolute; background: #000; color: #fff; padding: 8px 24px; font-family: var(--font-main); font-weight: bold; z-index: 100; letter-spacing: 6px; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }

        /* åŠ¨ç”» */
        @keyframes slow-spin { 0% { transform: rotateY(0deg) rotateX(20deg); } 100% { transform: rotateY(360deg) rotateX(380deg); } }
        @keyframes breathe { 0%,100% { transform: scale(1); box-shadow: 0 0 30px rgba(56, 189, 248, 0.4); } 50% { transform: scale(1.1); box-shadow: 0 0 50px rgba(56, 189, 248, 0.7); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* åå¸æç¤º */
        .toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: var(--gold); padding: 20px 40px; border: 1px solid var(--gold); border-radius: 8px; z-index: 100; font-size: 14px; letter-spacing: 2px; opacity: 0; pointer-events: none; transition: opacity 0.5s; text-align: center; }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>

    <canvas id="meteor-canvas"></canvas>
    <div class="hud-layer">
        <div class="logo-box"><div class="logo-main">ä¸‡è±¡å›å“</div></div>
        <div class="studio-mark">ZIGZAG STUDIO</div>
    </div>

    <!-- 1. å¼€åœº -->
    <div id="stage-intro" class="stage active">
        <div class="sphere-wrapper" onclick="startJourney()">
            <div class="rings-container">
                <div class="orbit"></div><div class="orbit"></div><div class="orbit"></div>
            </div>
            <div class="static-core"><div class="core-body"></div></div>
        </div>
        <div style="margin-top:40px; letter-spacing:6px; font-size:12px; color:#fff; text-shadow:0 0 10px rgba(56,189,248,0.5);">è§¦ç¢°æ˜Ÿå°˜ Â· å¼€å¯æ—…ç¨‹</div>
    </div>

    <!-- 2. æ—…ç¨‹æ»‘åŠ¨ (å…±ç”¨ä¸€ä¸ªç•Œé¢) -->
    <div id="stage-swipe" class="stage">
        <div class="journey-status">
            <div id="realm-title" class="current-realm">WEALTH</div>
            <div id="realm-progress" class="realm-progress">èƒ½é‡æ”¶é›†: 0/3</div>
        </div>

        <div class="card-container" id="card-stack"></div>
        
        <div class="controls">
            <div class="btn-act" style="color:#64748b" onclick="manualSwipe('left')">âœ•</div>
            <div class="btn-act" style="color:var(--gold)" onclick="manualSwipe('right')">â—‹</div>
        </div>
    </div>

    <!-- 3. åŠ è½½ -->
    <div id="stage-loading" class="stage">
        <div style="width:50px; height:50px; border:2px solid #333; border-top-color:var(--gold); border-radius:50%; animation:spin 1s linear infinite;"></div>
        <div style="margin-top:30px; letter-spacing:4px; font-size:12px;">æ­£åœ¨é‡æ„ç°å®...</div>
        <div id="loading-text" style="margin-top:10px; font-size:10px; color:#555;">0%</div>
    </div>

    <!-- 4. ç»“æœ -->
    <div id="stage-result" class="stage">
        <div class="result-preview-box"><img id="final-img" class="result-img" src=""></div>
        <div class="switch-btns">
            <div class="sw-btn active" id="btn-phone" onclick="showResult('phone')">æ‰‹æœºå£çº¸</div>
            <div class="sw-btn" id="btn-pad" onclick="showResult('pad')">iPadå£çº¸</div>
        </div>
        <div style="margin-top:30px; font-size:10px; color:#666;">é•¿æŒ‰ä¿å­˜ Â· è®¾å®šä¸ºé”å±</div>
        <div onclick="location.reload()" style="margin-top:20px; color:var(--gold); font-size:12px; cursor:pointer; text-decoration: underline;">é‡æ–°åˆ¶ä½œ</div>
    </div>

    <!-- æç¤ºæ¡† -->
    <div id="toast" class="toast">æ¿å—å®Œæˆ<br>è¿›å…¥ä¸‹ä¸€ç»´åº¦</div>

    <!-- ç”»å¸ƒ Phone -->
    <div id="canvas-phone" class="hidden-canvas">
        <div id="bg-phone" style="position:absolute; inset:0;"></div>
        <div id="layer-phone" style="position:absolute; inset:0;"></div>
        <div class="sticker-year" style="top:80px; left:40px; font-size:180px; opacity:0.9;">2026</div>
        <div class="sticker-text" style="bottom:120px; right:40px; font-size:24px;">MANIFEST</div>
    </div>

    <!-- ç”»å¸ƒ Pad -->
    <div id="canvas-pad" class="hidden-canvas">
        <div id="bg-pad" style="position:absolute; inset:0;"></div>
        <div id="layer-pad" style="position:absolute; inset:0;"></div>
        <div class="sticker-year" style="top:60px; right:60px; font-size:200px; opacity:0.9;">2026</div>
        <div class="sticker-text" style="bottom:80px; left:60px; font-size:32px;">DREAM LIFE</div>
    </div>

    <script>
        // ==========================================
        //  ğŸ‘‡ é…ç½®åŒº
        // ==========================================
        const BASE_URL = "https://cmkqytnhqfwhkjikozla.supabase.co/storage/v1/object/public/assets/";
        const MAX_PROBE_COUNT = 50; 

        // å®šä¹‰æ—…ç¨‹é¡ºåº
        const JOURNEY = [
            { key: 'WEALTH',  label: 'WEALTH',  target: 3 }, // è´¢å¯Œé€‰3å¼ 
            { key: 'BEAUTY',  label: 'BEAUTY',  target: 3 }, // ç¾è²Œé€‰3å¼ 
            { key: 'PARTNER', label: 'PARTNER', target: 3 }, // ä¼´ä¾£é€‰3å¼ 
            { key: 'LIFE',    label: 'LIFE',    target: 3 }  // ç”Ÿæ´»é€‰3å¼ 
        ];
        // æ€»ç›®æ ‡ = 3+3+3+3 = 12å¼ 

        // ==========================================
        //  ğŸ‘‡ é€»è¾‘åŒº
        // ==========================================

        function generatePotentialLinks(folder) {
            let arr = [];
            for (let i = 1; i <= MAX_PROBE_COUNT; i++) {
                // åŒæ—¶æ”¯æŒ jpg å’Œ png
                arr.push(`${BASE_URL}${folder}/${i}.jpg`);
            }
            return arr;
        }

        const rawDb = {
            WEALTH: generatePotentialLinks('WEALTH'),
            BEAUTY: generatePotentialLinks('BEAUTY'),
            PARTNER: generatePotentialLinks('PARTNER'),
            LIFE: generatePotentialLinks('LIFE')
        };

        // çŠ¶æ€ç®¡ç†
        let currentStepIndex = 0; // å½“å‰åœ¨ç¬¬å‡ ä¸ªæ¿å—
        let currentSelection = []; // å½“å‰æ¿å—å·²é€‰å›¾ç‰‡
        let finalSelection = [];   // æ€»å…±é€‰ä¸­çš„12å¼ å›¾
        let currentCards = [];     // å½“å‰å¡ç‰‡æ± 
        let generatedImages = { phone: null, pad: null };

        function switchStage(id) {
            document.querySelectorAll('.stage').forEach(el => el.classList.remove('active'));
            document.getElementById('stage-'+id).classList.add('active');
        }

        // --- 1. æ—…ç¨‹æ§åˆ¶ ---
        async function startJourney() {
            currentStepIndex = 0;
            finalSelection = [];
            await loadStep(currentStepIndex);
            switchStage('swipe');
        }

        async function loadStep(index) {
            if (index >= JOURNEY.length) {
                // å…¨éƒ¨å®Œæˆ
                prepareGeneration();
                return;
            }

            const step = JOURNEY[index];
            currentSelection = []; // æ¸…ç©ºå½“å‰æ¿å—é€‰æ‹©
            
            // UI æ›´æ–°
            document.getElementById('realm-title').innerText = step.label;
            updateProgressUI();

            // æ™ºèƒ½åŠ è½½å›¾ç‰‡
            const validImages = await validateAndLoadImages(step.key);
            
            if (validImages.length === 0) {
                alert(`æœªæ‰¾åˆ° ${step.key} æ¿å—çš„å›¾ç‰‡ï¼è¯·æ£€æŸ¥ Supabaseã€‚`);
                return;
            }

            // æ´—ç‰Œå¹¶å¡«å……
            currentCards = [...validImages].sort(() => Math.random() - 0.5);
            initStack();
        }

        async function validateAndLoadImages(key) {
            // è¿™é‡Œä¸ºäº†ä½“éªŒæµç•…ï¼Œä¸æ˜¾ç¤º Loadingï¼Œç›´æ¥åå°è·‘
            const potentialLinks = rawDb[key];
            const validLinks = [];
            await Promise.all(potentialLinks.map(url => {
                return new Promise(resolve => {
                    const img = new Image();
                    img.src = url;
                    img.onload = () => { validLinks.push(url); resolve(); };
                    img.onerror = () => { resolve(); };
                });
            }));
            // è‡ªåŠ¨å¡«å……é˜²æ­¢å¡æ­»
            if (validLinks.length > 0 && validLinks.length < 5) {
                while (validLinks.length < 10) validLinks.push(...validLinks);
            }
            return validLinks;
        }

        function updateProgressUI() {
            const step = JOURNEY[currentStepIndex];
            document.getElementById('realm-progress').innerText = `èƒ½é‡æ”¶é›†: ${currentSelection.length}/${step.target}`;
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerHTML = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 1500);
        }

        // --- 2. å¡ç‰‡äº¤äº’ ---
        let cardStackEl = document.getElementById('card-stack');
        let currentDragCard = null, startX = 0;

        function initStack() {
            cardStackEl.innerHTML = '';
            currentCards.forEach((url, i) => {
                if(i>3) return;
                let el = document.createElement('div');
                el.className = 'swipe-card';
                el.style.zIndex = 100-i;
                if(i>0) { el.style.transform = `scale(${1-i*0.05}) translateY(${i*15}px)`; el.style.opacity = 0.5; }
                el.innerHTML = `<img src="${url}" crossorigin="anonymous"><div class="stamp">YES</div>`;
                cardStackEl.appendChild(el);
            });
            bindEvents();
        }

        function bindEvents() {
            let cards = document.querySelectorAll('.swipe-card');
            if(cards.length===0) return;
            cards.forEach((c,i)=>{ c.style.display = i<3 ? 'block':'none'; });
            currentDragCard = cards[0];
            
            // å¦‚æœæ²¡å¡äº†ï¼Œè‡ªåŠ¨è¡¥å¡ï¼ˆå¾ªç¯æœºåˆ¶ï¼‰
            if(!currentDragCard && currentCards.length === 0) {
                // åº”è¯¥ä¸ä¼šå‘ç”Ÿï¼Œé€»è¾‘ä¸Š selected æ»¡äº†å°±è·³èµ°äº†
                return;
            }

            // ç»‘å®šäº‹ä»¶
            currentDragCard.addEventListener('touchstart', e=>{ startX=e.touches[0].clientX; currentDragCard.style.transition='none'; });
            currentDragCard.addEventListener('touchmove', e=>{ handleMove(e.touches[0].clientX - startX); });
            currentDragCard.addEventListener('touchend', e=>{ handleEnd(e.changedTouches[0].clientX - startX); });
            currentDragCard.onmousedown = e=>{
                startX=e.clientX; currentDragCard.style.transition='none';
                document.onmousemove = ev=>handleMove(ev.clientX - startX);
                document.onmouseup = ev=>{ handleEnd(ev.clientX - startX); document.onmousemove=null; };
            };
        }

        function handleMove(delta) {
            currentDragCard.style.transform = `translateX(${delta}px) rotate(${delta*0.1}deg)`;
            let stamp = currentDragCard.querySelector('.stamp');
            if(delta>50) { stamp.style.opacity = Math.min((delta-50)/100, 1); } 
            else { stamp.style.opacity = 0; }
        }

        function handleEnd(delta) {
            currentDragCard.style.transition = 'transform 0.3s ease';
            if(delta > 100) { // Right: Select
                const selectedImg = currentCards[0];
                currentSelection.push(selectedImg);
                finalSelection.push(selectedImg);
                updateProgressUI();
                flyAway(1);
            } 
            else if(delta < -100) { // Left: Pass
                // æ²¡é€‰ä¸­ï¼ŒæŠŠå®ƒæ”¾åˆ°æœ€åï¼Œå¾ªç¯å‡ºç°ï¼Œç›´åˆ°é€‰ä¸­ä¸ºæ­¢
                currentCards.push(currentCards[0]);
                flyAway(-1);
            } 
            else { 
                currentDragCard.style.transform = 'translateX(0)'; 
                currentDragCard.querySelector('.stamp').style.opacity = 0; 
            }
        }

        function flyAway(dir) {
            currentDragCard.style.transform = `translateX(${dir*500}px) rotate(${dir*30}deg)`;
            setTimeout(async ()=>{
                currentCards.shift();
                
                // æ£€æŸ¥å½“å‰æ¿å—æ˜¯å¦å®Œæˆ
                const step = JOURNEY[currentStepIndex];
                if (currentSelection.length >= step.target) {
                    // æ¿å—å®Œæˆï¼
                    if (currentStepIndex < JOURNEY.length - 1) {
                        showToast(`${step.label} èƒ½é‡é›†é½<br>è¿›å…¥ä¸‹ä¸€ç»´åº¦`);
                        currentStepIndex++;
                        await loadStep(currentStepIndex);
                    } else {
                        prepareGeneration();
                    }
                } else {
                    initStack();
                }
            }, 200);
        }
        function manualSwipe(dir) { if(currentDragCard) handleEnd(dir==='right'?150:-150); }


        /* --- 3. ç”Ÿæˆç®—æ³• (å®‰å…¨ç½‘æ ¼+å¾®æ‰°åŠ¨) --- */
        async function prepareGeneration() {
            switchStage('loading');
            document.body.classList.add('mode-dark');

            let loadedCount = 0;
            const total = finalSelection.length; // åº”è¯¥æ˜¯12å¼ 
            const updateLoadText = () => document.getElementById('loading-text').innerText = `åŠ è½½é«˜æ¸…ç´ æ ${Math.round((loadedCount/total)*100)}%`;
            
            await Promise.all(finalSelection.map(src => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.crossOrigin = "anonymous";
                    img.src = src;
                    img.onload = () => { loadedCount++; updateLoadText(); resolve(img); };
                    img.onerror = () => { loadedCount++; resolve(null); };
                });
            }));

            // ç”Ÿæˆä¸¤ç§å¸ƒå±€
            // æ‰‹æœºï¼š3åˆ— x 4è¡Œ = 12æ ¼
            layoutCanvas('phone', 1080, 1920, 3, 4);
            // Padï¼š4åˆ— x 3è¡Œ = 12æ ¼
            layoutCanvas('pad', 1600, 1200, 4, 3);

            setTimeout(async () => {
                generatedImages.phone = await render('canvas-phone');
                generatedImages.pad = await render('canvas-pad');
                showResult('phone');
                switchStage('result');
            }, 1000);
        }

        function layoutCanvas(type, W, H, cols, rows) {
            const bgContainer = document.getElementById('bg-'+type);
            const layerContainer = document.getElementById('layer-'+type);
            bgContainer.innerHTML = ''; layerContainer.innerHTML = '';

            // 1. åº•å±‚èƒŒæ™¯ (å–å‰6å¼ æ¨¡ç³Š)
            for(let i=0; i<6; i++) {
                let img = document.createElement('img');
                img.src = finalSelection[i % finalSelection.length];
                img.style.position = 'absolute';
                img.style.objectFit = 'cover';
                img.style.opacity = '0.4';
                img.style.filter = 'blur(40px) brightness(0.8)';
                // éšæœºé“ºæ»¡
                img.style.left = (Math.random()*W - W/2) + 'px';
                img.style.top = (Math.random()*H - H/2) + 'px';
                img.style.width = (W*1.5) + 'px';
                img.style.height = (H*1.5) + 'px';
                bgContainer.appendChild(img);
            }

            // 2. é¡¶å±‚ç½‘æ ¼ (Smart Grid)
            const cellW = W / cols;
            const cellH = H / rows;

            // ç¡®ä¿æˆ‘ä»¬æŒ‰é¡ºåºå¡«æ»¡æ ¼å­
            finalSelection.forEach((url, i) => {
                let col = i % cols;
                let row = Math.floor(i / cols);

                // æ ¸å¿ƒï¼šåœ¨å„è‡ªçš„æ ¼å­é‡Œå¾®è°ƒï¼Œä¸è·‘å‡ºå»
                // è®¡ç®—æ ¼å­ä¸­å¿ƒç‚¹
                let centerX = col * cellW + cellW / 2;
                let centerY = row * cellH + cellH / 2;

                // éšæœºæ‰°åŠ¨ (ä¸è¶…è¿‡æ ¼å­å®½åº¦çš„ 15%)
                let offsetX = (Math.random() - 0.5) * cellW * 0.3; 
                let offsetY = (Math.random() - 0.5) * cellH * 0.3;

                // éšæœºæ—‹è½¬ (è½»å¾®ï¼Œ+/- 6åº¦)
                let rot = (Math.random() - 0.5) * 12;

                // å›¾ç‰‡å°ºå¯¸ (ä¿æŒæ¯”ä¾‹ï¼Œç¨å¾®å¤§ä¸€ç‚¹ç‚¹ä»¥è¦†ç›–è¾¹ç¼)
                let w = cellW * 0.95; 
                let h = w * 1.4; // æ‹ç«‹å¾—æ¯”ä¾‹

                let div = document.createElement('div');
                div.className = 'collage-item';
                div.style.width = w + 'px';
                div.style.height = h + 'px';
                div.style.left = (centerX - w/2 + offsetX) + 'px';
                div.style.top = (centerY - h/2 + offsetY) + 'px';
                div.style.transform = `rotate(${rot}deg)`;
                div.style.zIndex = Math.floor(Math.random() * 10); // ç¨å¾®éšæœºå±‚çº§

                let img = document.createElement('img');
                img.src = url;
                img.className = 'collage-img';
                img.crossOrigin = "anonymous";

                div.appendChild(img);
                layerContainer.appendChild(div);
            });
        }

        async function render(id) {
            let c = await html2canvas(document.getElementById(id), { scale: 2, useCORS: true, backgroundColor:null });
            return c.toDataURL('image/jpeg', 0.9);
        }

        function showResult(t) {
            document.getElementById('final-img').src = generatedImages[t];
            document.querySelectorAll('.sw-btn').forEach(b=>b.classList.remove('active'));
            document.getElementById('btn-'+t).classList.add('active');
        }

        /* --- æµæ˜Ÿé›¨ --- */
        const canvas = document.getElementById('meteor-canvas');
        const ctx = canvas.getContext('2d');
        let w, height, meteors = [];
        window.addEventListener('resize', () => { w=canvas.width=window.innerWidth; height=canvas.height=window.innerHeight; });
        w=canvas.width=window.innerWidth; height=canvas.height=window.innerHeight;

        class Meteor {
            constructor() { this.reset(true); }
            reset(initial = false) {
                this.x = Math.random()*w + (initial?0:w/2);
                this.y = Math.random()*height/2 - height/2; 
                this.length = Math.random()*80 + 20;
                this.speed = Math.random()*8 + 4;
                this.size = Math.random()*2 + 0.5;
                this.angle = Math.PI/4 + (Math.random()-0.5)*0.2;
                this.opacity = Math.random()*0.5 + 0.1;
            }
            update() {
                this.x -= this.speed * Math.cos(this.angle);
                this.y += this.speed * Math.sin(this.angle);
                if(this.x < -100 || this.y > height+100) this.reset();
            }
            draw() {
                const tailX = this.x + this.length * Math.cos(this.angle);
                const tailY = this.y - this.length * Math.sin(this.angle);
                const gradient = ctx.createLinearGradient(this.x, this.y, tailX, tailY);
                gradient.addColorStop(0, `rgba(255, 255, 255, ${this.opacity})`);
                gradient.addColorStop(1, `rgba(255, 255, 255, 0)`);
                ctx.beginPath(); ctx.moveTo(this.x, this.y); ctx.lineTo(tailX, tailY);
                ctx.strokeStyle = gradient; ctx.lineWidth = this.size; ctx.lineCap = 'round'; ctx.stroke();
            }
        }
        for(let i=0; i<30; i++) meteors.push(new Meteor());
        function animate() {
            ctx.clearRect(0, 0, w, height);
            meteors.forEach(m => { m.update(); m.draw(); });
            requestAnimationFrame(animate);
        }
        animate();
    </script>
</body>
</html>
