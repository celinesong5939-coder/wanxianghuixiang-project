<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸‡è±¡å›å“ | æ„¿æ™¯æ¿</title>
    
    <link href="https://fonts.font.im/css2?family=Noto+Serif+SC:wght@300;700;900&family=Cinzel:wght@400;700&family=Caveat:wght@700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <script>
        (function() {
            const originalGetContext = HTMLCanvasElement.prototype.getContext;
            HTMLCanvasElement.prototype.getContext = function(type, attributes) {
                if (type === '2d') { attributes = attributes || {}; attributes.willReadFrequently = true; }
                return originalGetContext.call(this, type, attributes);
            };
        })();
    </script>

    <style>
        /* --- 0. åŸºç¡€ --- */
        :root { --bg-deep: #050a14; --gold: #d97706; --font-main: "Noto Serif SC", serif; --font-tech: "Cinzel", serif; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; background-color: var(--bg-deep); color: #94a3b8; font-family: var(--font-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; align-items: center; }

        #meteor-canvas { position: fixed; inset: 0; z-index: 0; pointer-events: none; opacity: 1; transition: opacity 1s; }
        body.mode-dark #meteor-canvas { opacity: 0.15; }

        .hud-layer { position: fixed; inset: 0; pointer-events: none; z-index: 10; }
        .logo-box { position: absolute; top: 24px; left: 24px; }
        .logo-main { font-size: 14px; font-weight: 900; letter-spacing: 2px; color: #fff; }
        .studio-mark { position: absolute; top: 28px; right: 24px; font-family: var(--font-tech); font-size: 10px; color: rgba(255,255,255,0.5); }

        .stage { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.5s ease; opacity: 0; pointer-events: none; transform: scale(0.98); z-index: 1; }
        .stage.active { opacity: 1; pointer-events: auto; transform: scale(1); z-index: 20; }

        /* --- 1. æ ¸å¿ƒ --- */
        .sphere-wrapper { width: 220px; height: 220px; position: relative; cursor: pointer; transition: transform 0.3s; }
        .sphere-wrapper:active { transform: scale(0.95); }
        .rings-container { position: absolute; inset: 0; transform-style: preserve-3d; perspective: 1000px; animation: slow-spin 20s linear infinite; }
        .orbit { position: absolute; inset: 0; border-radius: 50%; border: 1px dotted rgba(148, 163, 184, 0.4); box-shadow: 0 0 15px rgba(56, 189, 248, 0.1); }
        .orbit:nth-child(1) { transform: rotateY(0deg); border-style: solid; border-width: 0.5px; opacity: 0.6; }
        .orbit:nth-child(2) { transform: rotateY(60deg); }
        .orbit:nth-child(3) { transform: rotateY(120deg); }
        .static-core { position: absolute; top: 50%; left: 50%; width: 34px; height: 34px; transform: translate(-50%, -50%); }
        .core-body { width: 100%; height: 100%; border-radius: 50%; background: radial-gradient(circle at 35% 35%, #fff, #94a3b8 60%, #0f172a 100%); box-shadow: 0 0 40px rgba(56, 189, 248, 0.5); animation: breathe 3s infinite; }

        /* --- 2. çŠ¶æ€æ–‡å­— --- */
        .journey-status { position: absolute; top: 80px; width: 100%; text-align: center; }
        .status-content { transition: opacity 0.4s ease, transform 0.4s ease; opacity: 1; transform: translateY(0); }
        .status-content.fade-out { opacity: 0; transform: translateY(-10px); }
        
        .current-realm { font-family: var(--font-tech); font-size: 24px; letter-spacing: 4px; color: var(--gold); text-shadow: 0 0 10px rgba(217,119,6,0.3); }
        .realm-progress { font-size: 10px; letter-spacing: 2px; margin-top: 5px; color: #64748b; }

        /* --- 3. å¡ç‰‡ --- */
        .card-container { width: 100%; height: 55vh; position: relative; display: flex; justify-content: center; align-items: center; perspective: 1000px; margin-top: 20px; }
        .swipe-card { 
            position: absolute; width: 80%; max-width: 320px; aspect-ratio: 9/16; 
            background: #1e293b; border-radius: 8px; overflow: hidden; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.9); border: 4px solid #fff; border-bottom-width: 30px; 
            transform-origin: 50% 120%; transition: transform 0.1s linear; 
        }
        .swipe-card img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .stamp { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%) rotate(-15deg) scale(0); 
            border: 4px solid var(--gold); color: var(--gold); font-size: 32px; font-weight: 900; 
            padding: 10px 20px; opacity: 0; z-index: 10; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
        }

        .controls { position: absolute; bottom: 60px; width: 100%; display: flex; justify-content: center; gap: 80px; }
        .btn-act { font-size: 32px; cursor: pointer; transition: transform 0.1s; }
        .btn-act:active { transform: scale(0.9); }

        /* --- 4. ç»“æœ --- */
        .result-preview-box { width: 60%; max-width: 280px; margin-top: 20px; box-shadow: 0 0 60px rgba(0,0,0,0.8); border: 1px solid #333; }
        .result-img { width: 100%; display: block; }
        .switch-btns { display: flex; gap: 10px; margin-top: 30px; }
        .sw-btn { padding: 8px 20px; border: 1px solid rgba(255,255,255,0.2); color: #fff; font-size: 12px; border-radius: 20px; cursor: pointer; }
        .sw-btn.active { background: var(--gold); border-color: var(--gold); color: #000; font-weight: bold; }

        /* --- 5. ç”»å¸ƒ --- */
        .hidden-canvas { position: fixed; top: -9999px; left: 0; background: #080c14; overflow: hidden; }
        #canvas-phone { width: 1080px; height: 1920px; }
        #canvas-pad { width: 1600px; height: 1200px; }

        /* æ‹¼è´´ç»„ä»¶ */
        .bg-layer-img { position: absolute; object-fit: cover; opacity: 0.3; filter: blur(60px) contrast(1.2); transform: scale(1.5); }
        
        .collage-item { 
            position: absolute; padding: 12px 12px 45px 12px; 
            background: #fff; box-shadow: 0 20px 50px rgba(0,0,0,0.6); 
            transform-origin: center center; 
        }
        .collage-img { width: 100%; height: 100%; object-fit: cover; display: block; filter: contrast(1.05); }
        
        /* æå‡æ–‡å­—å±‚çº§ï¼Œç¡®ä¿ä¸è¢«é®æŒ¡ */
        .sticker-year { position: absolute; font-family: var(--font-tech); font-weight: 900; color: #fff; text-shadow: 0 10px 40px rgba(0,0,0,1); z-index: 999; pointer-events: none; }
        .sticker-text { position: absolute; background: #000; color: #fff; padding: 8px 24px; font-family: var(--font-main); font-weight: bold; z-index: 999; letter-spacing: 6px; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }

        @keyframes slow-spin { 0% { transform: rotateY(0deg) rotateX(20deg); } 100% { transform: rotateY(360deg) rotateX(380deg); } }
        @keyframes breathe { 0%,100% { transform: scale(1); box-shadow: 0 0 30px rgba(56, 189, 248, 0.4); } 50% { transform: scale(1.1); box-shadow: 0 0 50px rgba(56, 189, 248, 0.7); } }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <canvas id="meteor-canvas"></canvas>
    <div class="hud-layer">
        <div class="logo-box"><div class="logo-main">ä¸‡è±¡å›å“</div></div>
        <div class="studio-mark">ZIGZAG STUDIO</div>
    </div>

    <!-- 1. å¼€åœº -->
    <div id="stage-intro" class="stage active">
        <div class="sphere-wrapper" onclick="startJourney()">
            <div class="rings-container">
                <div class="orbit"></div><div class="orbit"></div><div class="orbit"></div>
            </div>
            <div class="static-core"><div class="core-body"></div></div>
        </div>
        <div style="margin-top:40px; letter-spacing:6px; font-size:12px; color:#fff; text-shadow:0 0 10px rgba(56,189,248,0.5);">è§¦ç¢°æ˜Ÿå°˜ Â· å¼€å¯æ—…ç¨‹</div>
    </div>

    <!-- 2. æ—…ç¨‹ -->
    <div id="stage-swipe" class="stage">
        <div class="journey-status">
            <div id="status-content" class="status-content">
                <div id="realm-title" class="current-realm">WEALTH</div>
                <div id="realm-progress" class="realm-progress">èƒ½é‡æ”¶é›†: 0/3</div>
            </div>
        </div>

        <div class="card-container" id="card-stack"></div>
        
        <div class="controls">
            <div class="btn-act" style="color:#64748b" onclick="manualSwipe('left')">âœ•</div>
            <div class="btn-act" style="color:var(--gold)" onclick="manualSwipe('right')">â—‹</div>
        </div>
    </div>

    <!-- 3. åŠ è½½ -->
    <div id="stage-loading" class="stage">
        <div style="width:50px; height:50px; border:2px solid #333; border-top-color:var(--gold); border-radius:50%; animation:spin 1s linear infinite;"></div>
        <div style="margin-top:30px; letter-spacing:4px; font-size:12px;">æ­£åœ¨é‡æ„ç°å®...</div>
        <div id="loading-text" style="margin-top:10px; font-size:10px; color:#555;">0%</div>
    </div>

    <!-- 4. ç»“æœ -->
    <div id="stage-result" class="stage">
        <div class="result-preview-box"><img id="final-img" class="result-img" src=""></div>
        <div class="switch-btns">
            <div class="sw-btn active" id="btn-phone" onclick="showResult('phone')">æ‰‹æœºå£çº¸</div>
            <div class="sw-btn" id="btn-pad" onclick="showResult('pad')">iPadå£çº¸</div>
        </div>
        <div style="margin-top:30px; font-size:10px; color:#666;">é•¿æŒ‰ä¿å­˜ Â· è®¾å®šä¸ºé”å±</div>
        <div onclick="location.reload()" style="margin-top:20px; color:var(--gold); font-size:12px; cursor:pointer; text-decoration: underline;">é‡æ–°åˆ¶ä½œ</div>
    </div>

    <!-- ç”»å¸ƒ Phone -->
    <div id="canvas-phone" class="hidden-canvas">
        <div id="bg-phone" style="position:absolute; inset:0;"></div>
        <div id="layer-phone" style="position:absolute; inset:0;"></div>
        <div class="sticker-year" style="top:80px; left:40px; font-size:180px; opacity:0.9;">2026</div>
        <div class="sticker-text" style="bottom:120px; right:40px; font-size:24px;">MANIFEST</div>
    </div>

    <!-- ç”»å¸ƒ Pad -->
    <div id="canvas-pad" class="hidden-canvas">
        <div id="bg-pad" style="position:absolute; inset:0;"></div>
        <div id="layer-pad" style="position:absolute; inset:0;"></div>
        <div class="sticker-year" style="top:60px; right:60px; font-size:200px; opacity:0.9;">2026</div>
        <div class="sticker-text" style="bottom:80px; left:60px; font-size:32px;">DREAM LIFE</div>
    </div>

    <script>
        // ================= é…ç½®åŒº =================
        const BASE_URL = "https://cmkqytnhqfwhkjikozla.supabase.co/storage/v1/object/public/assets/";
        const MAX_PROBE_COUNT = 100; 

        // æ—…ç¨‹é…ç½®
        const JOURNEY = [
            { key: 'WEALTH',  label: 'WEALTH',  target: 3 }, 
            { key: 'BEAUTY',  label: 'BEAUTY',  target: 3 }, 
            { key: 'PARTNER', label: 'PARTNER', target: 3 }, 
            { key: 'LIFE',    label: 'LIFE',    target: 3 }  
        ];

        // ================= é€»è¾‘åŒº =================

        function generatePotentialLinks(folder) {
            let arr = [];
            for (let i = 1; i <= MAX_PROBE_COUNT; i++) arr.push(`${BASE_URL}${folder}/${i}.jpg`);
            return arr;
        }

        const rawDb = {
            WEALTH: generatePotentialLinks('WEALTH'),
            BEAUTY: generatePotentialLinks('BEAUTY'),
            PARTNER: generatePotentialLinks('PARTNER'),
            LIFE: generatePotentialLinks('LIFE')
        };

        let currentStepIndex = 0;
        let currentSelection = []; 
        let finalSelection = [];   
        let currentCards = [];     
        let generatedImages = { phone: null, pad: null };

        function switchStage(id) {
            document.querySelectorAll('.stage').forEach(el => el.classList.remove('active'));
            document.getElementById('stage-'+id).classList.add('active');
        }

        // --- 1. æ—…ç¨‹æ§åˆ¶ (ä¿®å¤æŠ¥é”™ä¸å¡é¡¿) ---
        async function startJourney() {
            currentStepIndex = 0;
            finalSelection = [];
            await loadStep(currentStepIndex, true); 
            switchStage('swipe');
        }

        async function loadStep(index, isFirst = false) {
            // ğŸ›‘ ä¿®å¤ç‚¹ï¼šåœ¨è¿™é‡Œæ‹¦æˆªï¼Œå¦‚æœå·²ç»è¶…å‡ºäº†æ•°ç»„èŒƒå›´ï¼Œç›´æ¥å»ç”Ÿæˆï¼Œä¸è¿è¡Œä¸‹é¢çš„ä»£ç 
            if (index >= JOURNEY.length) {
                prepareGeneration();
                return;
            }

            const step = JOURNEY[index];
            currentSelection = [];
            
            // æ™ºèƒ½åŠ è½½å›¾ç‰‡
            const validImages = await validateAndLoadImages(step.key);
            if (validImages.length === 0) {
                alert(`æœªæ‰¾åˆ° ${step.key} å›¾ç‰‡ï¼Œè¯·æ£€æŸ¥ï¼`);
                return;
            }
            
            currentCards = [...validImages].sort(() => Math.random() - 0.5);

            // UI æ›´æ–°ä¸è½¬åœº
            const statusBox = document.getElementById('status-content');
            
            if (isFirst) {
                updateUI(step);
                initStack();
            } else {
                // å‘¼å¸è½¬åœº
                statusBox.classList.add('fade-out');
                setTimeout(() => {
                    updateUI(step);
                    initStack();
                    statusBox.classList.remove('fade-out');
                }, 500); // ç¨å¾®ç¼©çŸ­è½¬åœºæ—¶é—´ï¼Œæ„Ÿè§‰æ›´è½»å¿«
            }
        }

        function updateUI(step) {
            document.getElementById('realm-title').innerText = step.label;
            document.getElementById('realm-progress').innerText = `èƒ½é‡æ”¶é›†: 0/${step.target}`;
        }

        async function validateAndLoadImages(key) {
            const potentialLinks = rawDb[key];
            const validLinks = [];
            // å¹¶å‘æ£€æµ‹ï¼Œé€Ÿåº¦å¿«
            await Promise.all(potentialLinks.map(url => {
                return new Promise(resolve => {
                    const img = new Image();
                    img.src = url;
                    img.onload = () => { validLinks.push(url); resolve(); };
                    img.onerror = () => { resolve(); };
                });
            }));
            // å…œåº•å¡«å……
            if (validLinks.length > 0 && validLinks.length < 5) {
                while (validLinks.length < 10) validLinks.push(...validLinks);
            }
            return validLinks;
        }

        // --- 2. å¡ç‰‡äº¤äº’ ---
        let cardStackEl = document.getElementById('card-stack');
        let currentDragCard = null, startX = 0;

        function initStack() {
            cardStackEl.innerHTML = '';
            // åªæ¸²æŸ“å‰3å¼ ï¼Œå‡å°‘DOMå‹åŠ›ï¼Œæå‡æµç•…åº¦
            currentCards.slice(0, 3).forEach((url, i) => {
                let el = document.createElement('div');
                el.className = 'swipe-card';
                el.style.zIndex = 100-i;
                if(i>0) { el.style.transform = `scale(${1-i*0.05}) translateY(${i*15}px)`; el.style.opacity = 0.5; }
                el.innerHTML = `<img src="${url}" crossorigin="anonymous"><div class="stamp">YES</div>`;
                cardStackEl.appendChild(el);
            });
            bindEvents();
        }

        function bindEvents() {
            let cards = document.querySelectorAll('.swipe-card');
            if(cards.length===0) return;
            cards.forEach((c,i)=>{ c.style.display = i<3 ? 'block':'none'; }); // ç¡®ä¿åªæ˜¾ç¤ºå‰å‡ å¼ 
            currentDragCard = cards[0];
            
            if(!currentDragCard && currentCards.length === 0) return;

            // Touch
            currentDragCard.addEventListener('touchstart', e=>{ startX=e.touches[0].clientX; currentDragCard.style.transition='none'; });
            currentDragCard.addEventListener('touchmove', e=>{ handleMove(e.touches[0].clientX - startX); });
            currentDragCard.addEventListener('touchend', e=>{ handleEnd(e.changedTouches[0].clientX - startX); });
            // Mouse
            currentDragCard.onmousedown = e=>{
                startX=e.clientX; currentDragCard.style.transition='none';
                document.onmousemove = ev=>handleMove(ev.clientX - startX);
                document.onmouseup = ev=>{ handleEnd(ev.clientX - startX); document.onmousemove=null; };
            };
        }

        function handleMove(delta) {
            currentDragCard.style.transform = `translateX(${delta}px) rotate(${delta*0.1}deg)`;
            let stamp = currentDragCard.querySelector('.stamp');
            if(delta>50) { stamp.style.opacity = Math.min((delta-50)/100, 1); } 
            else { stamp.style.opacity = 0; }
        }

        function handleEnd(delta) {
            currentDragCard.style.transition = 'transform 0.3s ease';
            if(delta > 100) { // Right
                const selectedImg = currentCards[0];
                currentSelection.push(selectedImg);
                finalSelection.push(selectedImg);
                // å®æ—¶æ›´æ–°æ–‡å­—ï¼Œæ— éœ€ç­‰å¾…è½¬åœº
                document.getElementById('realm-progress').innerText = `èƒ½é‡æ”¶é›†: ${currentSelection.length}/${JOURNEY[currentStepIndex].target}`;
                flyAway(1);
            } 
            else if(delta < -100) { // Left
                currentCards.push(currentCards[0]); // æ”¾åˆ°é˜Ÿå°¾
                flyAway(-1);
            } 
            else { 
                currentDragCard.style.transform = 'translateX(0)'; 
                currentDragCard.querySelector('.stamp').style.opacity = 0; 
            }
        }

        function flyAway(dir) {
            currentDragCard.style.transform = `translateX(${dir*500}px) rotate(${dir*30}deg)`;
            
            // ä¼˜åŒ–ï¼šå‡å°‘ç­‰å¾…æ—¶é—´ï¼Œæ›´è·Ÿæ‰‹
            setTimeout(async ()=>{
                currentCards.shift();
                
                const step = JOURNEY[currentStepIndex];
                if (currentSelection.length >= step.target) {
                    // ğŸ›‘ ä¿®å¤ç‚¹ï¼šå…ˆåŠ ç´¢å¼•ï¼Œå†åˆ¤æ–­æ˜¯å¦ç»“æŸï¼Œé¿å… undefined
                    currentStepIndex++; 
                    // æ­¤æ—¶ loadStep å†…éƒ¨ä¼šåˆ¤æ–­ index æ˜¯å¦è¶…æ ‡ï¼Œè¶…æ ‡åˆ™ç”Ÿæˆï¼Œä¸è¶…æ ‡åˆ™åŠ è½½
                    await loadStep(currentStepIndex);
                } else {
                    initStack();
                }
            }, 250);
        }
        function manualSwipe(dir) { if(currentDragCard) handleEnd(dir==='right'?150:-150); }


        /* --- 3. ç”Ÿæˆç®—æ³• (å®šç‚¹å¸ƒå±€ - å½»åº•è§£å†³é®æŒ¡) --- */
        async function prepareGeneration() {
            switchStage('loading');
            document.body.classList.add('mode-dark');

            let loadedCount = 0;
            const total = finalSelection.length;
            const updateLoadText = () => document.getElementById('loading-text').innerText = `åŠ è½½é«˜æ¸…ç´ æ ${Math.round((loadedCount/total)*100)}%`;
            
            await Promise.all(finalSelection.map(src => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.crossOrigin = "anonymous";
                    img.src = src;
                    img.onload = () => { loadedCount++; updateLoadText(); resolve(img); };
                    img.onerror = () => { loadedCount++; resolve(null); };
                });
            }));

            // å®šç‚¹å¸ƒå±€ï¼šä¸å†éšæœºï¼Œä½¿ç”¨é¢„è®¾çš„å®Œç¾åæ ‡
            layoutFixed('phone', 1080, 1920);
            layoutFixed('pad', 1600, 1200);

            setTimeout(async () => {
                generatedImages.phone = await render('canvas-phone');
                generatedImages.pad = await render('canvas-pad');
                showResult('phone');
                switchStage('result');
            }, 1000);
        }

        // é¢„è®¾åæ ‡ç³» (x%, y%, width%, rotation, zIndex)
        // åˆ»æ„æ‹‰å¼€äº†å¤§å°å·®è·ï¼šä¸»å›¾(55%å®½) vs é…å›¾(25%å®½)
        const PHONE_LAYOUT = [
            // Cä½å¤§å›¾ (Hero)
            { x: 50, y: 35, w: 58, r: 0, z: 100 }, 
            { x: 50, y: 70, w: 58, r: -2, z: 99 }, 
            
            // å‘¨å›´ä¸­å›¾ (Support)
            { x: 18, y: 15, w: 32, r: -6, z: 10 },
            { x: 82, y: 15, w: 32, r: 5, z: 11 },
            { x: 12, y: 52, w: 28, r: 8, z: 12 },
            { x: 88, y: 52, w: 28, r: -8, z: 13 },
            { x: 20, y: 88, w: 35, r: -4, z: 14 },
            { x: 80, y: 88, w: 35, r: 4, z: 15 },
            
            // ç¼éš™å°å›¾ (Filler)
            { x: 50, y: 8,  w: 25, r: 0, z: 5 },
            { x: 50, y: 95, w: 25, r: 0, z: 6 },
            { x: 5,  y: 35, w: 20, r: -15, z: 1 },
            { x: 95, y: 35, w: 20, r: 15, z: 2 },
        ];

        const PAD_LAYOUT = [
            // iPad å¸ƒå±€é€»è¾‘ç±»ä¼¼
            { x: 35, y: 50, w: 45, r: -2, z: 100 }, 
            { x: 75, y: 40, w: 42, r: 3, z: 99 },   
            
            { x: 15, y: 20, w: 28, r: -5, z: 10 },
            { x: 50, y: 15, w: 28, r: 0, z: 11 },
            { x: 85, y: 15, w: 28, r: 5, z: 12 },
            { x: 10, y: 80, w: 28, r: 5, z: 13 },
            { x: 50, y: 85, w: 28, r: 0, z: 14 },
            { x: 90, y: 75, w: 28, r: -5, z: 15 },
            
            { x: 10, y: 50, w: 18, r: -10, z: 5 },
            { x: 90, y: 40, w: 18, r: 10, z: 6 },
            { x: 30, y: 85, w: 20, r: -3, z: 7 },
            { x: 70, y: 10, w: 20, r: 3, z: 8 },
        ];

        function layoutFixed(type, W, H) {
            const bgContainer = document.getElementById('bg-'+type);
            const layerContainer = document.getElementById('layer-'+type);
            bgContainer.innerHTML = ''; layerContainer.innerHTML = '';

            const layout = type === 'phone' ? PHONE_LAYOUT : PAD_LAYOUT;

            // 1. èƒŒæ™¯å±‚
            for(let i=0; i<6; i++) {
                let img = document.createElement('img');
                img.src = finalSelection[i % finalSelection.length];
                img.className = 'bg-layer-img';
                img.style.left = (Math.random()*W - W/2) + 'px';
                img.style.top = (Math.random()*H - H/2) + 'px';
                img.style.width = (W*1.5) + 'px'; img.style.height = (H*1.5) + 'px';
                bgContainer.appendChild(img);
            }

            // 2. æ ¸å¿ƒæ‹¼è´´å±‚
            // ç®€å•æ‰“ä¹±ï¼Œä½†ä¸ºäº†ä¿è¯æ•ˆæœï¼Œä¹Ÿå¯ä»¥ä¸æ‰“ä¹±ï¼Œç›´æ¥æŒ‰é¡ºåºå¡«
            // è¿™é‡Œçš„ç­–ç•¥æ˜¯ï¼šæœ€åé€‰çš„å›¾ï¼ˆé€šå¸¸æ˜¯æœ€å–œæ¬¢çš„ï¼‰æ”¾åœ¨æœ€å‰é¢
            let orderedImages = [...finalSelection].reverse(); // å€’åºï¼Œè®©æœ€è¿‘é€‰çš„æ”¾Cä½

            layout.forEach((pos, i) => {
                if (i >= orderedImages.length) return;
                
                let imgUrl = orderedImages[i];
                let w = (pos.w / 100) * W;
                let h = w * 1.35; // 3:4 æ¯”ä¾‹

                let div = document.createElement('div');
                div.className = 'collage-item';
                div.style.width = w + 'px';
                div.style.height = h + 'px';
                // åæ ‡è½¬æ¢
                div.style.left = ((pos.x / 100) * W - w/2) + 'px';
                div.style.top = ((pos.y / 100) * H - h/2) + 'px';
                div.style.transform = `rotate(${pos.r}deg)`;
                div.style.zIndex = pos.z;

                let img = document.createElement('img');
                img.src = imgUrl;
                img.className = 'collage-img';
                img.crossOrigin = "anonymous";

                div.appendChild(img);
                layerContainer.appendChild(div);
            });
        }

        async function render(id) {
            let c = await html2canvas(document.getElementById(id), { scale: 2, useCORS: true, backgroundColor:null });
            return c.toDataURL('image/jpeg', 0.9);
        }

        function showResult(t) {
            document.getElementById('final-img').src = generatedImages[t];
            document.querySelectorAll('.sw-btn').forEach(b=>b.classList.remove('active'));
            document.getElementById('btn-'+t).classList.add('active');
        }

        /* --- 5. æµæ˜Ÿé›¨ --- */
        const canvas = document.getElementById('meteor-canvas');
        const ctx = canvas.getContext('2d');
        let w, height, meteors = [];
        window.addEventListener('resize', () => { w=canvas.width=window.innerWidth; height=canvas.height=window.innerHeight; });
        w=canvas.width=window.innerWidth; height=canvas.height=window.innerHeight;

        class Meteor {
            constructor() { this.reset(true); }
            reset(initial = false) {
                this.x = Math.random()*w + (initial?0:w/2);
                this.y = Math.random()*height/2 - height/2; 
                this.length = Math.random()*80 + 20;
                this.speed = Math.random()*8 + 4;
                this.size = Math.random()*2 + 0.5;
                this.angle = Math.PI/4 + (Math.random()-0.5)*0.2;
                this.opacity = Math.random()*0.5 + 0.1;
            }
            update() {
                this.x -= this.speed * Math.cos(this.angle);
                this.y += this.speed * Math.sin(this.angle);
                if(this.x < -100 || this.y > height+100) this.reset();
            }
            draw() {
                const tailX = this.x + this.length * Math.cos(this.angle);
                const tailY = this.y - this.length * Math.sin(this.angle);
                const gradient = ctx.createLinearGradient(this.x, this.y, tailX, tailY);
                gradient.addColorStop(0, `rgba(255, 255, 255, ${this.opacity})`);
                gradient.addColorStop(1, `rgba(255, 255, 255, 0)`);
                ctx.beginPath(); ctx.moveTo(this.x, this.y); ctx.lineTo(tailX, tailY);
                ctx.strokeStyle = gradient; ctx.lineWidth = this.size; ctx.lineCap = 'round'; ctx.stroke();
            }
        }
        for(let i=0; i<30; i++) meteors.push(new Meteor());
        function animate() {
            ctx.clearRect(0, 0, w, height);
            meteors.forEach(m => { m.update(); m.draw(); });
            requestAnimationFrame(animate);
        }
        animate();
    </script>
</body>
</html>
